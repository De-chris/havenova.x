<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HX - Messages</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        :root { --bg:#020617; --surface:#0f172a; --card:#1e293b; --border:#334155; --text:#f8fafc; --primary:#38bdf8; --admin: #60a5fa; --owner: #f87171; --error: #ef4444; }
        * { box-sizing: border-box; font-family: "Inter", sans-serif; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: var(--text); padding-bottom: 80px; overflow-x: hidden; }
        
        body.is-working { pointer-events: none; opacity: 0.8; }
        header { background: var(--surface); padding: 15px; border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 1000; display: flex; align-items: center; justify-content: center; }
        .screen { padding: 15px; max-width: 600px; margin: 0 auto; display: none; }
        .screen.active { display: block; }
        
        /* ELITE UI & SPIKED BADGE */
        .name-owner { color: var(--owner) !important; text-shadow: 0 0 10px rgba(248, 113, 113, 0.4); font-weight: 800 !important; animation: ownerGlow 2s infinite ease-in-out; }
        .name-admin { color: var(--admin) !important; text-shadow: 0 0 10px rgba(96, 165, 250, 0.4); font-weight: 700 !important; }
        @keyframes ownerGlow { 0%, 100% { filter: brightness(1); } 50% { filter: brightness(1.3); } }

        .badge-spiked { position: relative; display: inline-flex; align-items: center; justify-content: center; margin-left: 4px; color: var(--primary); font-size: 12px; filter: drop-shadow(0 0 5px rgba(56, 189, 248, 0.6)); vertical-align: middle; }
        .badge-spiked i.fa-certificate { font-size: 16px; }
        .badge-spiked i.fa-check { position: absolute; font-size: 8px; color: #000; font-weight: 900; }
        
        /* SHIMMER SKELETON */
        .img-wrapper { background: rgba(56, 189, 248, 0.1); position: relative; overflow: hidden; border-radius: 12px; display: flex; align-items: center; justify-content: center; }
        .img-wrapper.is-loaded { background: transparent !important; }
        .img-wrapper.is-loaded::after { display: none !important; }
        .img-wrapper::after { content: ""; position: absolute; inset: 0; background: linear-gradient(90deg, transparent, rgba(56, 189, 248, 0.2), transparent); animation: shimmer 1.5s infinite; }
        @keyframes shimmer { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }
        .hx-pfp { opacity: 0; transition: opacity 0.3s ease-in; width: 100%; height: 100%; object-fit: cover; }
        .loaded { opacity: 1 !important; }

        .hx-input { width: 100%; background: #0f172a; border: 1px solid var(--border); color: white; padding: 12px; border-radius: 12px; outline: none; margin-bottom: 15px; }
        .user-card { background: var(--card); padding: 12px; border-radius: 16px; border: 1px solid var(--border); display: flex; align-items: center; gap: 12px; margin-bottom: 10px; cursor: pointer; transition: 0.2s; }
        
        /* NAV BAR */
        .nav-bar { position: fixed; bottom: 0; left: 0; right: 0; background: var(--surface); border-top: 1px solid var(--border); display: flex; justify-content: space-around; padding: 14px 0; z-index: 1000; }
        .nav-item { color: #94a3b8; font-size: 20px; cursor: pointer; }
        .nav-item.active { color: var(--primary); }

        /* CHAT BUBBLES */
        .chat-container { height: 62vh; overflow-y: auto; display: flex; flex-direction: column; padding: 10px; gap: 8px; }
        .bubble-wrapper { display: flex; width: 100%; margin-bottom: 4px; }
        .chat-bubble { padding: 10px 15px; border-radius: 18px; max-width: 80%; line-height: 1.4; word-wrap: break-word; font-size: 14px; }
        .wrapper-me { justify-content: flex-end; }
        .bubble-me { background: var(--primary); color: #000; border-bottom-right-radius: 4px; }
        .wrapper-them { justify-content: flex-start; }
        .bubble-them { background: var(--card); color: #fff; border-bottom-left-radius: 4px; border: 1px solid var(--border); }
        .sys-warning { color: #ff4d4d; font-weight: bold; border-left: 3px solid #ff4d4d; padding-left: 8px; font-size: 13px; }
    </style>
</head>
<body id="main-body">
    <header>
        <h3>Inbox</h3>
    </header>
    
    <div id="list-screen" class="screen active">
        <input type="text" id="userSearch" class="hx-input" placeholder="Search members..." oninput="filterUsers()">
        <div id="user-list">Scanning community...</div>
    </div>

    <div id="chat-screen" class="screen">
        <div style="display:flex; align-items:center; gap:12px; margin-bottom:20px; border-bottom: 1px solid var(--border); padding-bottom: 10px;">
            <i class="fas fa-arrow-left" onclick="showList()" style="cursor:pointer"></i>
            <div class="img-wrapper" style="width:32px; height:32px; border-radius: 8px;"><img id="chat-target-pfp" class="hx-pfp" onload="handleImgLoad(this)"></div>
            <b id="chat-target-name">@User</b>
        </div>
        <div id="chat-messages" class="chat-container"></div>
        <div style="display: flex; gap: 8px; margin-top: 15px; background: var(--surface); padding: 10px; border-radius: 15px;">
            <input type="text" id="msgInput" class="hx-input" style="margin:0; border:none;" placeholder="Write a message..." onkeydown="if(event.key==='Enter') sendDM()">
            <button onclick="sendDM()" style="background:var(--primary); width:45px; height:45px; border-radius:12px; border:none; cursor:pointer;"><i class="fas fa-paper-plane" style="color:#000"></i></button>
        </div>
    </div>

    <nav class="nav-bar">
        <div class="nav-item" onclick="location.href='community.html'"><i class="fas fa-home"></i></div>
        <div class="nav-item active"><i class="fas fa-comments"></i></div>
        <div class="nav-item" onclick="location.href='profile.html'"><i class="fas fa-user-circle"></i></div>
    </nav>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxgjbIKQJUn5Tdo3r5KbmNQPU-ntffm2hJrw2PrsiqCKf8wa8wzpH-0m_h9nLpcc-JWwg/exec";
        const currentUser = localStorage.getItem("hx_comm_user");
        let roleCache = JSON.parse(localStorage.getItem("hx_roles_cache") || "{}");
        let allUsers = []; 
        let viewTarget = "";

        if (!currentUser) location.href = 'profile.html';

        function handleImgLoad(el) { el.classList.add('loaded'); const wrapper = el.closest('.img-wrapper'); if (wrapper) wrapper.classList.add('is-loaded'); }

        function linkify(text) {
            if(!text) return "";
            let processed = text.replace(/\*(.*?)\*/g, "<b>$1</b>")
                                .replace(/_(.*?)_/g, "<i>$1</i>")
                                .replace(/@(\w+)/g, (m, u) => `<span style="color:var(--primary); font-weight:bold" onclick="location.href='profile.html?user=${u}'">@${u}</span>`);
            if(text.includes("System Warning:")) processed = `<span class="sys-warning">${processed}</span>`;
            return processed;
        }

        function getEliteName(u) {
            const r = (roleCache[u.toLowerCase()] || "User").trim();
            let icon = "";
            if (r === "Owner") icon = `<span class="badge-spiked"><i class="fas fa-certificate"></i><i class="fas fa-check"></i></span>`;
            else if (r === "Admin") icon = ' <i class="fas fa-shield-alt"></i>';
            let cls = r === "Owner" ? "name-owner" : (r === "Admin" ? "name-admin" : "");
            return `<span class="${cls}">@${u}${icon}</span>`;
        }

        async function loadInbox() {
            document.getElementById('main-body').classList.add('is-working');
            try {
                const r = await fetch(`${SCRIPT_URL}?action=get_users`);
                const res = await r.json();
                allUsers = Array.isArray(res.data) ? res.data : [];
                allUsers.forEach(u => { roleCache[u.username.toLowerCase()] = u.role; });
                localStorage.setItem("hx_roles_cache", JSON.stringify(roleCache));
                filterUsers();
            } catch (e) { document.getElementById("user-list").innerText = "Error loading users."; }
            document.getElementById('main-body').classList.remove('is-working');
        }

        function filterUsers() {
            const q = document.getElementById("userSearch").value.toLowerCase();
            const container = document.getElementById("user-list");
            const filtered = allUsers.filter(u => u.username !== currentUser && u.username.toLowerCase().includes(q));
            
            if (filtered.length === 0) {
                container.innerHTML = `<p style="text-align:center; padding:20px; color:#94a3b8">No community members found.</p>`;
                return;
            }

            container.innerHTML = filtered.map(u => {
                const pfp = u.pic || `https://ui-avatars.com/api/?name=${u.username}`;
                return `
                <div class="user-card" onclick="openChat('${u.username}', '${u.pic}')">
                    <div class="img-wrapper" style="width:40px; height:40px;"><img src="${pfp}" class="hx-pfp" onload="handleImgLoad(this)"></div>
                    <div style="flex:1; overflow:hidden;">
                        <b>${getEliteName(u.username)}</b>
                        <div style="font-size:12px; color:#94a3b8; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Tap to start chatting</div>
                    </div>
                </div>`;
            }).join("");
        }

        async function openChat(username, pic) {
            viewTarget = username;
            window.history.pushState({}, '', `messages.html?chat=${username}`);
            document.getElementById("chat-target-name").innerHTML = getEliteName(username);
            document.getElementById("chat-target-pfp").src = pic || `https://ui-avatars.com/api/?name=${username}`;
            document.getElementById("list-screen").classList.remove("active");
            document.getElementById("chat-screen").classList.add("active");
            loadMessages();
        }

        function showList() {
            window.history.pushState({}, '', `messages.html`);
            document.getElementById("chat-screen").classList.remove("active");
            document.getElementById("list-screen").classList.add("active");
        }

        async function loadMessages() {
            const r = await fetch(`${SCRIPT_URL}?action=get_dms&uid=${currentUser}&target=${viewTarget}`);
            const res = await r.json();
            const container = document.getElementById("chat-messages");
            const msgs = Array.isArray(res.data) ? res.data : [];
            container.innerHTML = msgs.map(m => {
                const isMe = m[0] == currentUser;
                return `
                <div class="bubble-wrapper ${isMe ? 'wrapper-me' : 'wrapper-them'}">
                    <div class="chat-bubble ${isMe ? 'bubble-me' : 'bubble-them'}">
                        ${linkify(m[2])}
                    </div>
                </div>`;
            }).join("");
            container.scrollTop = container.scrollHeight;
        }

        async function sendDM() {
            const val = document.getElementById("msgInput").value.trim();
            if(!val) return;
            const container = document.getElementById("chat-messages");
            container.innerHTML += `<div class="bubble-wrapper wrapper-me"><div class="chat-bubble bubble-me">${linkify(val)}</div></div>`;
            container.scrollTop = container.scrollHeight;
            document.getElementById("msgInput").value = "";
            await fetch(SCRIPT_URL, { method: "POST", body: JSON.stringify({ action: "dm", uid: currentUser, target: viewTarget, message: val }) });
            loadMessages();
        }

        window.addEventListener('load', async () => {
            await loadInbox();
            const params = new URLSearchParams(window.location.search);
            const chatTarget = params.get('chat');
            if (chatTarget) openChat(chatTarget, "");
        });
    </script>
</body>
</html>