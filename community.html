<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>HX Community</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
    />
    <style>
      :root {
        --bg: #020617;
        --surface: #0f172a;
        --card: #1e293b;
        --border: #334155;
        --text: #f8fafc;
        --muted: #94a3b8;
        --primary: #38bdf8;
        --error: #ef4444;
        --success: #22c55e;
      }
      * {
        box-sizing: border-box;
        font-family: "Inter", sans-serif;
        margin: 0;
        padding: 0;
        -webkit-tap-highlight-color: transparent;
      }
      body {
        background: var(--bg);
        color: var(--text);
        padding-bottom: 80px;
        overflow-x: hidden;
        scroll-behavior: smooth;
      }
      .screen {
        display: none !important;
        padding: 15px;
        max-width: 600px;
        margin: 0 auto;
        min-height: 100vh;
        animation: fadeIn 0.3s ease;
      }
      .screen.active {
        display: block !important;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(5px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      header {
        background: rgba(15, 23, 42, 0.95);
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 15px;
        height: 50px;
        position: sticky;
        top: 0;
        z-index: 1000;
        backdrop-filter: blur(10px);
      }
      .logo {
        height: 22px;
        cursor: pointer;
      }
      .fab {
        position: fixed;
        bottom: 90px;
        right: 20px;
        width: 55px;
        height: 55px;
        border-radius: 18px;
        background: var(--primary);
        color: #000;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 22px;
        box-shadow: 0 4px 15px rgba(56, 189, 248, 0.4);
        z-index: 900;
        cursor: pointer;
        transition: 0.3s;
        display: none;
      }
      .fab.visible {
        display: flex;
      }
      .hx-card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 15px;
        margin-bottom: 12px;
        position: relative;
      }
      .hx-user-row {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 10px;
        cursor: pointer;
      }
      .hx-pfp {
        width: 40px;
        height: 40px;
        border-radius: 12px;
        background: var(--primary);
        display: flex;
        align-items: center;
        justify-content: center;
        color: #000;
        font-weight: bold;
        overflow: hidden;
        border: 1px solid var(--border);
        object-fit: cover;
      }
      .hx-media {
        width: 100%;
        border-radius: 12px;
        margin-top: 10px;
        border: 1px solid var(--border);
        max-height: 400px;
        object-fit: cover;
        background: #000;
      }
      .hx-action {
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        margin-right: 20px;
        font-size: 14px;
        color: var(--muted);
      }
      .hx-action.liked {
        color: var(--error) !important;
      }
      .card-top-actions {
        position: absolute;
        top: 15px;
        right: 15px;
        display: flex;
        gap: 12px;
      }
      .hx-util-btn {
        color: var(--muted);
        font-size: 14px;
        cursor: pointer;
      }
      .stats-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin: 15px 0;
      }
      .stat-card {
        background: rgba(255, 255, 255, 0.05);
        padding: 12px;
        border-radius: 12px;
        text-align: center;
        border: 1px solid var(--border);
      }
      .stat-num {
        display: block;
        font-size: 18px;
        font-weight: bold;
        color: var(--primary);
      }
      .hx-btn {
        background: var(--primary);
        color: #000;
        border: none;
        padding: 12px;
        border-radius: 12px;
        font-weight: bold;
        width: 100%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        transition: 0.2s;
      }
      .hx-btn.outline {
        background: transparent;
        border: 1px solid var(--primary);
        color: var(--primary);
      }
      .hx-input {
        width: 100%;
        background: #0f172a;
        border: 1px solid var(--border);
        color: white;
        padding: 12px;
        border-radius: 12px;
        outline: none;
        margin-bottom: 10px;
      }
      .nav-bar {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: var(--surface);
        border-top: 1px solid var(--border);
        display: flex;
        justify-content: space-around;
        padding: 14px 0;
        z-index: 1000;
      }
      .nav-item {
        color: var(--muted);
        font-size: 20px;
        cursor: pointer;
      }
      .nav-item.active {
        color: var(--primary);
      }
      #bg-loader {
        position: fixed;
        top: 65px;
        left: 50%;
        transform: translateX(-50%);
        background: var(--primary);
        color: #000;
        padding: 8px 20px;
        border-radius: 30px;
        font-size: 12px;
        font-weight: bold;
        z-index: 2000;
        display: none;
      }
      .live-preview {
        background: rgba(56, 189, 248, 0.05);
        border: 1px dashed var(--primary);
        padding: 10px;
        border-radius: 10px;
        margin-bottom: 15px;
        font-size: 14px;
        min-height: 20px;
        color: #e2e8f0;
        white-space: pre-wrap;
      }
      .preview-label {
        font-size: 10px;
        color: var(--primary);
        font-weight: bold;
        text-transform: uppercase;
        margin-bottom: 4px;
        display: block;
      }
    </style>
  </head>
  <body>
    <div id="bg-loader">
      <i class="fas fa-satellite-dish fa-spin"></i> SYNCING...
    </div>

    <header>
      <img src="logo1.png" class="logo" onclick="openScreen('home')" />
      <i
        class="fas fa-sync-alt"
        style="color: var(--primary); cursor: pointer"
        onclick="loadFeed(true)"
      ></i>
    </header>

    <div class="fab" id="mainFab" onclick="handleFab()">
      <i class="fas fa-plus"></i>
    </div>

    <div id="home-screen" class="screen active">
      <div id="feed-container"></div>
    </div>
    <div id="dm-screen" class="screen">
      <h3>Messages</h3>
      <div id="dm-list-container"></div>
    </div>

    <div id="chat-view-screen" class="screen">
      <div
        style="
          display: flex;
          align-items: center;
          gap: 12px;
          margin-bottom: 15px;
          border-bottom: 1px solid var(--border);
          padding-bottom: 12px;
        "
      >
        <i class="fas fa-arrow-left" onclick="openScreen('dm')"></i
        ><b id="chat-target-name">@User</b>
      </div>
      <div id="chat-messages" style="height: 60vh; overflow-y: auto"></div>
      <div style="display: flex; gap: 10px; margin-top: 10px">
        <input
          type="text"
          id="msgInput"
          class="hx-input"
          style="margin: 0"
          placeholder="Message..."
        />
        <button class="hx-btn" style="width: 50px" onclick="sendDM()">
          <i class="fas fa-paper-plane"></i>
        </button>
      </div>
    </div>

    <div id="comment-view-screen" class="screen">
      <div
        style="
          display: flex;
          align-items: center;
          gap: 12px;
          margin-bottom: 15px;
        "
      >
        <i class="fas fa-arrow-left" onclick="openScreen('home')"></i>
        <h3>Comments</h3>
      </div>
      <div id="full-comment-list" style="margin-bottom: 80px"></div>
      <div
        style="
          position: fixed;
          bottom: 75px;
          left: 0;
          right: 0;
          padding: 15px;
          background: var(--surface);
          border-top: 1px solid var(--border);
        "
      >
        <span class="preview-label">Comment Preview:</span>
        <div id="comment-preview" class="live-preview"></div>
        <div style="display: flex; gap: 8px; max-width: 600px; margin: 0 auto">
          <input
            type="text"
            id="active-comment-input"
            class="hx-input"
            style="margin: 0"
            placeholder="Write a comment..."
            oninput="updatePreview('active-comment-input', 'comment-preview')"
          />
          <button class="hx-btn" style="width: 70px" onclick="sendComment()">
            Post
          </button>
        </div>
      </div>
    </div>

    <div id="compose-screen" class="screen">
      <h3>New Broadcast</h3>
      <textarea
        id="postText"
        class="hx-input"
        style="height: 120px; margin-top: 15px"
        placeholder="What's happening?"
        oninput="updatePreview('postText', 'post-preview')"
      ></textarea>
      <span class="preview-label">Live Preview:</span>
      <div id="post-preview" class="live-preview"></div>
      <input
        type="file"
        id="postFile"
        accept="image/*"
        style="display: none"
        onchange="uploadToCatbox(this, 'imageUrlInput', 'post-up-status')"
      />
      <button
        class="hx-btn outline"
        onclick="document.getElementById('postFile').click()"
      >
        <i class="fas fa-camera"></i> Media
      </button>
      <span id="post-up-status" class="upload-status"></span>
      <input type="hidden" id="imageUrlInput" />
      <button
        class="hx-btn"
        onclick="submitBroadcast()"
        style="margin-top: 10px"
      >
        Broadcast Now
      </button>
    </div>

    <div id="profile-screen" class="screen">
      <div id="login-view">
        <h3>Welcome</h3>
        <input
          type="text"
          id="logUser"
          class="hx-input"
          placeholder="Username"
        />
        <input
          type="password"
          id="logPass"
          class="hx-input"
          placeholder="Password"
        />
        <button class="hx-btn" onclick="userAuth('login')">Login</button>
        <p
          style="
            text-align: center;
            margin-top: 15px;
            cursor: pointer;
            font-size: 14px;
          "
          onclick="toggleAuthView('signup')"
        >
          New? Create Account
        </p>
      </div>
      <div id="signup-view" style="display: none">
        <h3>Join HX</h3>
        <input
          type="text"
          id="sigUser"
          class="hx-input"
          placeholder="Username"
        />
        <input
          type="email"
          id="sigEmail"
          class="hx-input"
          placeholder="Email"
        />
        <input
          type="password"
          id="sigPass"
          class="hx-input"
          placeholder="Password"
        />
        <input
          type="file"
          id="pfpFile"
          accept="image/*"
          style="display: none"
          onchange="uploadToCatbox(this, 'sigPfp', 'sig-up-status')"
        />
        <button
          class="hx-btn outline"
          onclick="document.getElementById('pfpFile').click()"
        >
          Import PFP
        </button>
        <span id="sig-up-status" class="upload-status"></span>
        <input type="hidden" id="sigPfp" />
        <button
          class="hx-btn"
          onclick="userAuth('signup')"
          style="margin-top: 10px"
        >
          Sign Up
        </button>
      </div>
      <div id="profile-box" style="display: none; text-align: center">
        <img
          class="hx-pfp"
          id="pfpBig"
          style="
            width: 80px;
            height: 80px;
            margin: 0 auto 10px;
            border: 2px solid var(--primary);
          "
        />
        <h2 id="nameDisplay">@User</h2>
        <p
          id="bioDisplay"
          style="color: var(--muted); font-size: 13px; margin-bottom: 10px"
        ></p>
        <div id="my-stats" class="stats-grid"></div>
        <div
          style="
            border-top: 1px solid var(--border);
            padding-top: 15px;
            margin-top: 10px;
          "
        >
          <input
            type="text"
            id="updateBio"
            class="hx-input"
            placeholder="Edit Bio..."
          />
          <input
            type="file"
            id="updatePfpFile"
            accept="image/*"
            style="display: none"
            onchange="uploadToCatbox(this, 'updatePfpUrl', 'profile-up-status')"
          />
          <button
            class="hx-btn outline"
            onclick="document.getElementById('updatePfpFile').click()"
          >
            Update Picture
          </button>
          <span id="profile-up-status" class="upload-status"></span>
          <input type="hidden" id="updatePfpUrl" />
          <button
            class="hx-btn"
            id="saveProfileBtn"
            style="margin-top: 10px"
            onclick="updateProfileData()"
          >
            Save Profile
          </button>
        </div>
        <button
          class="hx-btn"
          style="background: var(--error); color: white; margin-top: 20px"
          onclick="logout()"
        >
          Logout
        </button>
      </div>
    </div>

    <div id="user-profile-screen" class="screen">
      <i class="fas fa-arrow-left" onclick="openScreen('home')"></i>
      <div style="text-align: center; margin-top: 15px">
        <img
          class="hx-pfp"
          style="width: 80px; height: 80px; margin: 0 auto 10px"
          id="view-pfp"
        />
        <h2 id="view-name">@User</h2>
        <p
          id="view-bio"
          style="color: var(--muted); font-size: 13px; margin-bottom: 10px"
        ></p>
        <div class="stats-grid" id="user-profile-stats"></div>
        <div style="display: flex; gap: 10px; margin-top: 15px">
          <button class="hx-btn" id="followBtn" onclick="toggleFollow()">
            Follow
          </button>
          <button class="hx-btn outline" onclick="startChat(viewTarget)">
            Message
          </button>
        </div>
      </div>
    </div>

    <nav class="nav-bar">
      <div class="nav-item active" id="nav-home" onclick="openScreen('home')">
        <i class="fas fa-home"></i>
      </div>
      <div class="nav-item" id="nav-dm" onclick="openScreen('dm')">
        <i class="fas fa-comments"></i>
      </div>
      <div class="nav-item" id="nav-profile" onclick="openScreen('profile')">
        <i class="fas fa-user-circle"></i>
      </div>
    </nav>

    <script>
      const SCRIPT_URL =
        "https://script.google.com/macros/s/AKfycbwFLdZch3piPyZQI3wXx_egiv6J0gztXtYECfyoeuCQ0CKOnrwYU4e1b4DudzTsyUUasA/exec";
      let currentUser = localStorage.getItem("hx_comm_user");
      let likedPosts = JSON.parse(
        localStorage.getItem("hx_comm_liked") || "[]"
      );
      let viewTarget = "";
      let currentActivePost = "";

      function linkify(text) {
        if (!text) return "";
        const urlPattern =
          /(\b(https?):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gi;
        return text
          .replace(
            urlPattern,
            '<a href="$1" target="_blank" class="hx-link" style="color:var(--primary);">$1</a>'
          )
          .replace(/\*(.*?)\*/g, "<b>$1</b>")
          .replace(/_(.*?)_/g, "<i>$1</i>")
          .replace(/~(.*?)~/g, "<strike>$1</strike>")
          .replace(
            /@(\w+)/g,
            '<span class="hx-username-link" style="color:var(--primary); font-weight:bold; cursor:pointer;" onclick="viewProfile(\'$1\')">@$1</span>'
          );
      }

      function updatePreview(inputId, previewId) {
        const val = document.getElementById(inputId).value;
        document.getElementById(previewId).innerHTML =
          linkify(val) || "No text yet...";
      }

      function openScreen(id) {
        document
          .querySelectorAll(".screen")
          .forEach((s) => s.classList.remove("active"));
        document
          .querySelectorAll(".nav-item")
          .forEach((n) => n.classList.remove("active"));
        document.getElementById(id + "-screen").classList.add("active");
        document.getElementById("nav-" + id)?.classList.add("active");
        document
          .getElementById("mainFab")
          .classList.toggle("visible", id === "home");
        if (id === "home") loadFeed();
        if (id === "dm") loadDMList();
        if (id === "profile") checkUserStatus();
      }

      async function uploadToCatbox(fileInput, hiddenId, statusId) {
        const file = fileInput.files[0];
        if (!file) return;
        document.getElementById(statusId).innerText = "Syncing...";
        const formData = new FormData();
        formData.append("reqtype", "fileupload");
        formData.append("fileToUpload", file);
        try {
          const res = await fetch(
            "https://corsproxy.io/?" +
              encodeURIComponent("https://catbox.moe/user/api.php"),
            { method: "POST", body: formData }
          );
          const url = await res.text();
          document.getElementById(hiddenId).value = url.trim();
          document.getElementById(statusId).innerText = "Linked! ✅";
          if (hiddenId === "sigPfp" || hiddenId === "updatePfpUrl")
            document.getElementById("pfpBig").src = url.trim();
        } catch (e) {
          document.getElementById(statusId).innerText = "Failed ❌";
        }
      }

      async function loadFeed(force = false) {
        const r = await fetch(`${SCRIPT_URL}?action=get_feed`);
        const res = await r.json();
        const container = document.getElementById("feed-container");
        container.innerHTML = "";
        res.data.forEach((p) => {
          const isOwner = p.author === currentUser;
          const isLiked = likedPosts.includes(p.pid);
          const card = document.createElement("div");
          card.className = "hx-card";
          card.id = `post-${p.pid}`;
          card.innerHTML = `
            <div class="card-top-actions">
                <i class="fas fa-share hx-util-btn" onclick="sharePost('${
                  p.pid
                }')"></i>
                <i class="fas fa-paper-plane hx-util-btn" onclick="startChat('${
                  p.author
                }')"></i>
                ${
                  isOwner
                    ? `<i class="fas fa-trash hx-util-btn" style="color:var(--error)" onclick="deletePost('${p.pid}')"></i>`
                    : ""
                }
            </div>
            <div class="hx-user-row" onclick="viewProfile('${p.author}')">
                <img src="${
                  p.pic || "https://ui-avatars.com/api/?name=" + p.author
                }" class="hx-pfp">
                <b>@${p.author}</b>
            </div>
            <div style="white-space:pre-wrap;">${linkify(p.content)}</div>
            ${p.media ? `<img src="${p.media}" class="hx-media">` : ""}
            <div style="margin-top:15px; display:flex; gap:25px; border-top:1px solid rgba(255,255,255,0.05); padding-top:10px;">
                <span class="hx-action ${
                  isLiked ? "liked" : ""
                }" onclick="doLike('${
            p.pid
          }', this)"><i class="fas fa-heart"></i> <span class="l-count">${
            p.likes
          }</span></span>
                <span class="hx-action" onclick="openComments('${
                  p.pid
                }')"><i class="far fa-comment"></i> ${p.comment_count}</span>
            </div>`;
          container.appendChild(card);
        });
      }

      function sharePost(pid) {
        const url = `${window.location.origin}${window.location.pathname}?post=${pid}`;
        if (navigator.share) navigator.share({ title: "HX Post", url: url });
        else {
          navigator.clipboard.writeText(url);
          alert("Link copied!");
        }
      }

      async function doLike(pid, btn) {
        if (!currentUser || likedPosts.includes(pid)) return;
        likedPosts.push(pid);
        localStorage.setItem("hx_comm_liked", JSON.stringify(likedPosts));
        btn.classList.add("liked");
        const count = btn.querySelector(".l-count");
        count.innerText = parseInt(count.innerText) + 1;
        fetch(SCRIPT_URL, {
          method: "POST",
          body: JSON.stringify({ action: "like", pid: pid, uid: currentUser }),
        });
      }

      async function deletePost(pid) {
        if (!confirm("Delete forever?")) return;
        document.getElementById(`post-${pid}`).style.display = "none";
        fetch(SCRIPT_URL, {
          method: "POST",
          body: JSON.stringify({
            action: "delete_post",
            pid: pid,
            uid: currentUser,
          }),
        });
      }

      async function updateProfileData() {
        const updates = JSON.parse(
          localStorage.getItem(`updates_${currentUser}`) || "[]"
        );
        const now = Date.now();
        const last7Days = updates.filter((t) => now - t < 7 * 86400000);
        if (last7Days.length >= 2) return alert("Limit reached: 2 per week.");
        const bio = document.getElementById("updateBio").value.trim();
        const pic = document.getElementById("updatePfpUrl").value.trim();
        document.getElementById("bg-loader").style.display = "block";
        const res = await fetch(SCRIPT_URL, {
          method: "POST",
          body: JSON.stringify({
            action: "update_profile",
            uid: currentUser,
            pic: pic,
            bio: bio,
          }),
        });
        if ((await res.json()).status === "Success") {
          last7Days.push(now);
          localStorage.setItem(
            `updates_${currentUser}`,
            JSON.stringify(last7Days)
          );
          location.reload();
        }
      }

      async function userAuth(mode) {
        let payload = {
          action: mode,
          username: document.getElementById("logUser").value,
          password: document.getElementById("logPass").value,
        };
        if (mode === "signup") {
          payload.username = document.getElementById("sigUser").value;
          payload.email = document.getElementById("sigEmail").value;
          payload.password = document.getElementById("sigPass").value;
          payload.pic = document.getElementById("sigPfp").value;
        }
        document.getElementById("bg-loader").style.display = "block";
        const res = await fetch(SCRIPT_URL, {
          method: "POST",
          body: JSON.stringify(payload),
        });
        const data = await res.json();
        if (data.status === "Success") {
          localStorage.setItem("hx_comm_user", data.data.username);
          location.reload();
        } else alert(data.data);
      }

      function checkUserStatus() {
        if (currentUser) {
          document.getElementById("login-view").style.display = "none";
          document.getElementById("profile-box").style.display = "block";
          document.getElementById("nameDisplay").innerText = "@" + currentUser;
          fetchStats(currentUser, "my-stats");
          fetch(`${SCRIPT_URL}?action=get_user_data&uid=${currentUser}`)
            .then((r) => r.json())
            .then((res) => {
              document.getElementById("pfpBig").src =
                res.data.pic ||
                `https://ui-avatars.com/api/?name=${currentUser}`;
              document.getElementById("bioDisplay").innerText =
                res.data.bio || "No bio yet.";
              document.getElementById("updateBio").value = res.data.bio || "";
            });
        }
      }

      async function fetchStats(uid, elementId) {
        const r = await fetch(
          `${SCRIPT_URL}?action=get_social_stats&uid=${uid}`
        );
        const res = await r.json();
        const fers = res.data.followers || 0;
        const fing = res.data.following || 0;
        const container = document.getElementById(elementId);
        if (container) {
          container.innerHTML = `<div class="stat-card"><span class="stat-num">${fers}</span>Followers</div><div class="stat-card"><span class="stat-num">${fing}</span>Following</div>`;
        }
        return res.data;
      }

      async function viewProfile(u) {
        if (u === currentUser) return openScreen("profile");
        viewTarget = u;
        openScreen("user-profile");
        document.getElementById("view-name").innerText = "@" + u;
        const followBtn = document.getElementById("followBtn");
        followBtn.innerText = "...";
        fetch(`${SCRIPT_URL}?action=get_user_data&uid=${u}`)
          .then((r) => r.json())
          .then((res) => {
            document.getElementById("view-pfp").src =
              res.data.pic || `https://ui-avatars.com/api/?name=${u}`;
            document.getElementById("view-bio").innerText =
              res.data.bio || "No bio.";
          });
        const mySocial = await fetchStats(currentUser, null);
        const followingList = mySocial.followingList || [];
        followBtn.innerText = followingList.includes(viewTarget)
          ? "Unfollow"
          : "Follow";
        await fetchStats(u, "user-profile-stats");
      }

      async function toggleFollow() {
        const btn = document.getElementById("followBtn");
        btn.disabled = true;
        const res = await fetch(SCRIPT_URL, {
          method: "POST",
          body: JSON.stringify({
            action: "follow",
            uid: currentUser,
            target: viewTarget,
          }),
        });
        btn.innerText =
          (await res.json()).data === "Followed" ? "Unfollow" : "Follow";
        await fetchStats(viewTarget, "user-profile-stats");
        btn.disabled = false;
      }

      async function loadDMList() {
        const res = await fetch(`${SCRIPT_URL}?action=get_users`);
        const data = await res.json();
        document.getElementById("dm-list-container").innerHTML = data.data
          .filter((u) => u.username !== currentUser)
          .map(
            (u) =>
              `<div class="hx-card" style="display:flex; align-items:center; gap:12px; cursor:pointer;" onclick="startChat('${
                u.username
              }')"><img src="${
                u.pic || "https://ui-avatars.com/api/?name=" + u.username
              }" class="hx-pfp" style="width:35px; height:35px;"><b>@${
                u.username
              }</b></div>`
          )
          .join("");
      }

      async function startChat(t) {
        viewTarget = t;
        openScreen("chat-view");
        document.getElementById("chat-target-name").innerText = "@" + t;
        loadDMs();
      }
      async function loadDMs() {
        const r = await fetch(
          `${SCRIPT_URL}?action=get_dms&uid=${currentUser}&target=${viewTarget}`
        );
        const res = await r.json();
        document.getElementById("chat-messages").innerHTML = res.data
          .map(
            (m) =>
              `<div style="text-align:${
                m[0] == currentUser ? "right" : "left"
              }; margin-bottom:10px;"><div style="display:inline-block; padding:8px 12px; border-radius:12px; background:${
                m[0] == currentUser ? "var(--primary)" : "var(--card)"
              }; color:${m[0] == currentUser ? "#000" : "#fff"}">${linkify(
                m[2]
              )}</div></div>`
          )
          .join("");
        document.getElementById("chat-messages").scrollTop =
          document.getElementById("chat-messages").scrollHeight;
      }

      async function sendDM() {
        const i = document.getElementById("msgInput");
        if (!i.value) return;
        await fetch(SCRIPT_URL, {
          method: "POST",
          body: JSON.stringify({
            action: "dm",
            uid: currentUser,
            target: viewTarget,
            message: i.value,
          }),
        });
        i.value = "";
        loadDMs();
      }

      function openComments(pid) {
        currentActivePost = pid;
        fetch(`${SCRIPT_URL}?action=get_feed`)
          .then((r) => r.json())
          .then((res) => {
            const post = res.data.find((x) => x.pid === pid);
            const list = document.getElementById("full-comment-list");
            list.innerHTML = post.recent_comments.length
              ? ""
              : "<p style='text-align:center; padding:40px; color:var(--muted)'>No comments.</p>";
            post.recent_comments.forEach((c) => {
              list.innerHTML += `<div class="comment-item"><b>@${
                c.user
              }</b><p>${linkify(c.text)}</p></div>`;
            });
            openScreen("comment-view");
          });
      }

      async function sendComment() {
        const input = document.getElementById("active-comment-input");
        if (!input.value) return;
        await fetch(SCRIPT_URL, {
          method: "POST",
          body: JSON.stringify({
            action: "comment",
            pid: currentActivePost,
            uid: currentUser,
            content: input.value,
          }),
        });
        input.value = "";
        document.getElementById("comment-preview").innerHTML = "";
        openScreen("home");
      }

      async function submitBroadcast() {
        const t = document.getElementById("postText").value;
        const m = document.getElementById("imageUrlInput").value;
        document.getElementById("bg-loader").style.display = "block";
        await fetch(SCRIPT_URL, {
          method: "POST",
          body: JSON.stringify({
            action: "post",
            uid: currentUser,
            content: t,
            media: m,
          }),
        });
        location.reload();
      }

      function handleFab() {
        currentUser ? openScreen("compose") : openScreen("profile");
      }
      function logout() {
        localStorage.removeItem("hx_comm_user");
        location.reload();
      }
      function toggleAuthView(v) {
        document.getElementById("login-view").style.display =
          v === "login" ? "block" : "none";
        document.getElementById("signup-view").style.display =
          v === "signup" ? "block" : "none";
      }

      if (currentUser) loadFeed();
      else openScreen("profile");
    </script>
  </body>
</html>
