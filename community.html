<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>HX Community</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
    />
    <style>
      :root {
        --bg: #020617;
        --surface: #0f172a;
        --card: #1e293b;
        --border: #334155;
        --text: #f8fafc;
        --muted: #94a3b8;
        --primary: #38bdf8;
        --error: #ef4444;
        --success: #22c55e;
        --admin: #60a5fa;
        --owner: #f87171;
      }
      * {
        box-sizing: border-box;
        font-family: "Inter", sans-serif;
        margin: 0;
        padding: 0;
        -webkit-tap-highlight-color: transparent;
      }
      body {
        background: var(--bg);
        color: var(--text);
        padding-bottom: 80px;
        overflow-x: hidden;
        scroll-behavior: smooth;
      }

      /* ELITE UI STYLES */
      .name-owner {
        color: var(--owner) !important;
        text-shadow: 0 0 10px rgba(248, 113, 113, 0.4);
        font-weight: 800 !important;
        animation: ownerGlow 2s infinite ease-in-out;
      }
      .name-admin {
        color: var(--admin) !important;
        text-shadow: 0 0 10px rgba(96, 165, 250, 0.4);
        font-weight: 700 !important;
      }
      @keyframes ownerGlow {
        0%,
        100% {
          opacity: 1;
          filter: brightness(1);
        }
        50% {
          opacity: 0.9;
          filter: brightness(1.2);
        }
      }

      .screen {
        display: none !important;
        padding: 15px;
        max-width: 600px;
        margin: 0 auto;
        min-height: 100vh;
        animation: fadeIn 0.3s ease;
      }
      .screen.active {
        display: block !important;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(5px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      header {
        background: rgba(15, 23, 42, 0.95);
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 15px;
        height: 50px;
        position: sticky;
        top: 0;
        z-index: 1000;
        backdrop-filter: blur(10px);
      }
      .logo {
        height: 22px;
        cursor: pointer;
      }

      .fab {
        position: fixed;
        bottom: 90px;
        right: 20px;
        width: 55px;
        height: 55px;
        border-radius: 18px;
        background: var(--primary);
        color: #000;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 22px;
        box-shadow: 0 4px 15px rgba(56, 189, 248, 0.4);
        z-index: 900;
        cursor: pointer;
        transition: 0.3s;
        display: none;
      }
      .fab.visible {
        display: flex;
      }

      .hx-card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 15px;
        margin-bottom: 12px;
        position: relative;
      }
      .hx-user-row {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 10px;
        cursor: pointer;
        max-width: 75%;
      }
      .hx-pfp {
        width: 40px;
        height: 40px;
        border-radius: 12px;
        background: var(--primary);
        display: flex;
        align-items: center;
        justify-content: center;
        color: #000;
        font-weight: bold;
        border: 1px solid var(--border);
        object-fit: cover;
      }
      .hx-media {
        width: 100%;
        border-radius: 12px;
        margin-top: 10px;
        border: 1px solid var(--border);
        max-height: 400px;
        object-fit: cover;
      }

      .card-top-actions {
        position: absolute;
        top: 18px;
        right: 15px;
        display: flex;
        gap: 14px;
        background: var(--card);
      }
      .hx-util-btn {
        color: var(--muted);
        font-size: 15px;
        cursor: pointer;
      }

      .hx-btn {
        background: var(--primary);
        color: #000;
        border: none;
        padding: 12px;
        border-radius: 12px;
        font-weight: bold;
        width: 100%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: 0.2s;
      }
      .hx-btn.outline {
        background: transparent;
        border: 1px solid var(--primary);
        color: var(--primary);
      }
      .hx-input {
        width: 100%;
        background: #0f172a;
        border: 1px solid var(--border);
        color: white;
        padding: 12px;
        border-radius: 12px;
        outline: none;
        margin-bottom: 10px;
      }

      .nav-bar {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: var(--surface);
        border-top: 1px solid var(--border);
        display: flex;
        justify-content: space-around;
        padding: 14px 0;
        z-index: 1000;
      }
      .nav-item {
        color: var(--muted);
        font-size: 20px;
        cursor: pointer;
      }
      .nav-item.active {
        color: var(--primary);
      }
      .live-preview {
        background: rgba(255, 255, 255, 0.03);
        border: 1px dashed var(--border);
        padding: 10px;
        border-radius: 10px;
        margin-bottom: 10px;
        font-size: 14px;
        color: #94a3b8;
        white-space: pre-wrap;
        min-height: 40px;
      }
      #bg-loader {
        position: fixed;
        top: 65px;
        left: 50%;
        transform: translateX(-50%);
        background: var(--primary);
        color: #000;
        padding: 8px 20px;
        border-radius: 30px;
        font-size: 12px;
        font-weight: bold;
        z-index: 2000;
        display: none;
      }
      .upload-status {
        font-size: 11px;
        color: var(--success);
        display: block;
        margin: 5px 0;
        text-align: center;
      }
    </style>
  </head>
  <body>
    <div id="bg-loader">SYNCING...</div>

    <header>
      <img src="logo1.png" class="logo" onclick="openScreen('home')" />
      <i
        class="fas fa-sync-alt"
        style="color: var(--primary); cursor: pointer"
        onclick="loadFeed(true)"
      ></i>
    </header>

    <div class="fab" id="mainFab" onclick="handleFab()">
      <i class="fas fa-plus"></i>
    </div>

    <div id="home-screen" class="screen active">
      <div id="feed-container"></div>
    </div>

    <div id="dm-screen" class="screen">
      <h3>Messages</h3>
      <input
        type="text"
        id="userSearch"
        class="hx-input"
        placeholder="Search users..."
        oninput="filterUsers()"
        style="margin-top: 10px"
      />
      <div id="dm-list-container"></div>
    </div>

    <div id="chat-view-screen" class="screen">
      <div
        style="
          display: flex;
          align-items: center;
          gap: 12px;
          margin-bottom: 15px;
          border-bottom: 1px solid var(--border);
          padding-bottom: 12px;
        "
      >
        <i class="fas fa-arrow-left" onclick="openScreen('dm')"></i
        ><b id="chat-target-name">@User</b>
      </div>
      <div id="chat-messages" style="height: 60vh; overflow-y: auto"></div>
      <div style="display: flex; gap: 10px; margin-top: 10px">
        <input
          type="text"
          id="msgInput"
          class="hx-input"
          style="margin: 0"
          placeholder="Message..."
        />
        <button class="hx-btn" style="width: 50px" onclick="sendDM()">
          <i class="fas fa-paper-plane"></i>
        </button>
      </div>
    </div>

    <div id="comment-view-screen" class="screen">
      <div
        style="
          display: flex;
          align-items: center;
          gap: 12px;
          margin-bottom: 15px;
        "
      >
        <i class="fas fa-arrow-left" onclick="openScreen('home')"></i>
        <h3>Comments</h3>
      </div>
      <div id="full-comment-list" style="margin-bottom: 80px"></div>
      <div
        style="
          position: fixed;
          bottom: 75px;
          left: 0;
          right: 0;
          padding: 15px;
          background: var(--surface);
          border-top: 1px solid var(--border);
        "
      >
        <div id="comment-preview" class="live-preview"></div>
        <div style="display: flex; gap: 8px; max-width: 600px; margin: 0 auto">
          <input
            type="text"
            id="active-comment-input"
            class="hx-input"
            style="margin: 0"
            placeholder="Write a comment..."
            oninput="updatePreview('active-comment-input', 'comment-preview')"
          />
          <button class="hx-btn" style="width: 70px" onclick="sendComment()">
            Post
          </button>
        </div>
      </div>
    </div>

    <div id="compose-screen" class="screen">
      <h3>New Broadcast</h3>
      <textarea
        id="postText"
        class="hx-input"
        style="height: 120px; margin-top: 15px"
        placeholder="What's happening?"
        oninput="updatePreview('postText', 'post-preview')"
      ></textarea>
      <div id="post-preview" class="live-preview"></div>
      <input
        type="file"
        id="postFile"
        accept="image/*"
        style="display: none"
        onchange="uploadToCatbox(this, 'imageUrlInput', 'post-up-status')"
      />
      <button
        class="hx-btn outline"
        onclick="document.getElementById('postFile').click()"
      >
        <i class="fas fa-camera"></i> Media
      </button>
      <span id="post-up-status" class="upload-status"></span>
      <input type="hidden" id="imageUrlInput" />
      <button
        class="hx-btn"
        onclick="submitBroadcast()"
        style="margin-top: 10px"
      >
        Broadcast Now
      </button>
    </div>

    <div id="profile-screen" class="screen">
      <div id="login-view">
        <h3>Welcome</h3>
        <input
          type="text"
          id="logUser"
          class="hx-input"
          placeholder="Username"
        />
        <input
          type="password"
          id="logPass"
          class="hx-input"
          placeholder="Password"
        />
        <button class="hx-btn" onclick="userAuth('login')">Login</button>
        <p
          style="text-align: center; margin-top: 15px; cursor: pointer"
          onclick="toggleAuthView('signup')"
        >
          Create Account
        </p>
      </div>
      <div id="signup-view" style="display: none">
        <h3>Join HX</h3>
        <input
          type="text"
          id="sigUser"
          class="hx-input"
          placeholder="Username"
        />
        <input
          type="email"
          id="sigEmail"
          class="hx-input"
          placeholder="Email"
        />
        <input
          type="password"
          id="sigPass"
          class="hx-input"
          placeholder="Password"
        />
        <input
          type="file"
          id="pfpFile"
          accept="image/*"
          style="display: none"
          onchange="uploadToCatbox(this, 'sigPfp', 'sig-up-status')"
        />
        <button
          class="hx-btn outline"
          onclick="document.getElementById('pfpFile').click()"
        >
          Import PFP
        </button>
        <span id="sig-up-status" class="upload-status"></span>
        <input type="hidden" id="sigPfp" />
        <button
          class="hx-btn"
          onclick="userAuth('signup')"
          style="margin-top: 10px"
        >
          Sign Up
        </button>
      </div>
      <div id="profile-box" style="display: none; text-align: center">
        <img
          class="hx-pfp"
          id="pfpBig"
          style="
            width: 80px;
            height: 80px;
            margin: 0 auto 10px;
            border: 2px solid var(--primary);
          "
        />
        <h2 id="nameDisplay">@User</h2>
        <p
          id="bioDisplay"
          style="color: var(--muted); font-size: 13px; margin: 10px 0"
        ></p>
        <div id="my-stats" class="stats-grid"></div>
        <div
          style="
            border-top: 1px solid var(--border);
            padding-top: 15px;
            margin-top: 10px;
          "
        >
          <input
            type="text"
            id="updateBio"
            class="hx-input"
            placeholder="Edit Bio..."
          />
          <input
            type="file"
            id="updatePfpFile"
            accept="image/*"
            style="display: none"
            onchange="uploadToCatbox(this, 'updatePfpUrl', 'profile-up-status')"
          />
          <button
            class="hx-btn outline"
            onclick="document.getElementById('updatePfpFile').click()"
          >
            Update Picture
          </button>
          <span id="profile-up-status" class="upload-status"></span>
          <input type="hidden" id="updatePfpUrl" />
          <button
            class="hx-btn"
            style="margin-top: 10px"
            onclick="updateProfileData()"
          >
            Save Profile
          </button>
        </div>
        <button
          class="hx-btn"
          style="background: var(--error); color: white; margin-top: 20px"
          onclick="logout()"
        >
          Logout
        </button>
      </div>
    </div>

    <div id="user-profile-screen" class="screen">
      <i class="fas fa-arrow-left" onclick="openScreen('home')"></i>
      <div style="text-align: center; margin-top: 15px">
        <img
          class="hx-pfp"
          style="width: 80px; height: 80px; margin: 0 auto 10px"
          id="view-pfp"
        />
        <h2 id="view-name">@User</h2>
        <p
          id="view-bio"
          style="color: var(--muted); font-size: 13px; margin-bottom: 10px"
        ></p>
        <div class="stats-grid" id="user-profile-stats"></div>
        <div style="display: flex; gap: 10px; margin-top: 15px">
          <button class="hx-btn" id="followBtn" onclick="toggleFollow()">
            Follow
          </button>
          <button class="hx-btn outline" onclick="startChat(viewTarget)">
            Message
          </button>
        </div>
      </div>
    </div>

    <nav class="nav-bar">
      <div class="nav-item active" id="nav-home" onclick="openScreen('home')">
        <i class="fas fa-home"></i>
      </div>
      <div class="nav-item" id="nav-dm" onclick="openScreen('dm')">
        <i class="fas fa-comments"></i>
      </div>
      <div class="nav-item" id="nav-profile" onclick="openScreen('profile')">
        <i class="fas fa-user-circle"></i>
      </div>
    </nav>

    <script>
      const SCRIPT_URL =
        "https://script.google.com/macros/s/AKfycby_XMBGnauA-2fm7b8K96rLUJIpHgeV3VZ_I_mkynLo0vWnVUEdaz-nvwq72ZomydT7SA/exec";
      let currentUser = localStorage.getItem("hx_comm_user");
      let currentRole = localStorage.getItem("hx_comm_role") || "User";
      let likedPosts = JSON.parse(
        localStorage.getItem("hx_comm_liked") || "[]"
      );
      let viewTarget = "";
      let roleCache = JSON.parse(
        localStorage.getItem("hx_roles_cache") || "{}"
      );
      let allUsersData = [];

      function getEliteName(username) {
        if (!username) return "";
        const role = (roleCache[username.toLowerCase()] || "User").trim();
        if (role === "Owner")
          return `<span class="name-owner">@${username} <i class="fas fa-shield-alt"></i></span>`;
        if (role === "Admin")
          return `<span class="name-admin">@${username} <i class="fas fa-bolt"></i></span>`;
        return `<span>@${username}</span>`;
      }

      function linkify(text) {
        if (!text) return "";
        const urlPattern =
          /(\b(https?):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gi;
        return text
          .replace(
            urlPattern,
            '<a href="$1" target="_blank" style="color:var(--primary);">$1</a>'
          )
          .replace(/\*(.*?)\*/g, "<b>$1</b>")
          .replace(/_(.*?)_/g, "<i>$1</i>")
          .replace(/~(.*?)~/g, "<strike>$1</strike>")
          .replace(
            /@(\w+)/g,
            (m, u) =>
              `<span onclick="viewProfile('${u}')" style="cursor:pointer">${getEliteName(
                u
              )}</span>`
          );
      }

      function updatePreview(inputId, previewId) {
        document.getElementById(previewId).innerHTML =
          linkify(document.getElementById(inputId).value) || "...";
      }

      async function loadFeed(force = false) {
        const r = await fetch(`${SCRIPT_URL}?action=get_feed`);
        const res = await r.json();
        const container = document.getElementById("feed-container");
        container.innerHTML = "";
        res.data.forEach((p) => {
          roleCache[p.author.toLowerCase()] = p.role;
          const hasPower = currentRole === "Admin" || currentRole === "Owner";
          const card = document.createElement("div");
          card.className = "hx-card";
          card.id = `post-${p.pid}`;
          card.innerHTML = `
            <div class="card-top-actions">
                <i class="fas fa-share hx-util-btn" onclick="sharePost('${
                  p.pid
                }')"></i>
                <i class="fas fa-paper-plane hx-util-btn" onclick="startChat('${
                  p.author
                }')"></i>
                ${
                  p.author === currentUser || hasPower
                    ? `<i class="fas fa-trash hx-util-btn" style="color:var(--error)" onclick="deletePost('${p.pid}', '${p.author}')"></i>`
                    : ""
                }
            </div>
            <div class="hx-user-row" onclick="viewProfile('${p.author}')">
                <img src="${
                  p.pic || "https://ui-avatars.com/api/?name=" + p.author
                }" class="hx-pfp">
                <b>${getEliteName(p.author)}</b>
            </div>
            <div style="white-space:pre-wrap; margin-top:5px;">${linkify(
              p.content
            )}</div>
            ${p.media ? `<img src="${p.media}" class="hx-media">` : ""}
            <div style="margin-top:15px; display:flex; gap:25px; border-top:1px solid rgba(255,255,255,0.05); padding-top:10px;">
                <span class="hx-action ${
                  likedPosts.includes(p.pid) ? "liked" : ""
                }" onclick="doLike('${
            p.pid
          }', this)"><i class="fas fa-heart"></i> <span class="l-count">${
            p.likes
          }</span></span>
                <span class="hx-action" onclick="openComments('${
                  p.pid
                }')"><i class="far fa-comment"></i> ${p.comment_count}</span>
            </div>`;
          container.appendChild(card);
        });
        localStorage.setItem("hx_roles_cache", JSON.stringify(roleCache));
      }

      async function uploadToCatbox(fileInput, hiddenId, statusId) {
        const file = fileInput.files[0];
        if (!file) return;
        document.getElementById(statusId).innerText = "Syncing...";
        const fd = new FormData();
        fd.append("reqtype", "fileupload");
        fd.append("fileToUpload", file);
        try {
          const r = await fetch(
            "https://corsproxy.io/?" +
              encodeURIComponent("https://catbox.moe/user/api.php"),
            { method: "POST", body: fd }
          );
          const url = await r.text();
          document.getElementById(hiddenId).value = url.trim();
          document.getElementById(statusId).innerText = "Linked! ✅";
          if (hiddenId === "updatePfpUrl")
            document.getElementById("pfpBig").src = url.trim();
        } catch (e) {
          document.getElementById(statusId).innerText = "Failed ❌";
        }
      }

      async function updateProfileData() {
        const bio = document.getElementById("updateBio").value.trim();
        const pic = document.getElementById("updatePfpUrl").value.trim();
        document.getElementById("bg-loader").style.display = "block";
        await fetch(SCRIPT_URL, {
          method: "POST",
          body: JSON.stringify({
            action: "update_profile",
            uid: currentUser,
            bio: bio,
            pic: pic,
          }),
        });
        location.reload();
      }

      function checkUserStatus() {
        if (currentUser) {
          document.getElementById("login-view").style.display = "none";
          document.getElementById("profile-box").style.display = "block";
          fetchStats(currentUser, "my-stats");
          fetch(`${SCRIPT_URL}?action=get_user_data&uid=${currentUser}`)
            .then((r) => r.json())
            .then((res) => {
              document.getElementById("pfpBig").src =
                res.data.pic ||
                `https://ui-avatars.com/api/?name=${currentUser}`;
              document.getElementById("bioDisplay").innerText =
                res.data.bio || "No bio.";
              document.getElementById("updateBio").value = res.data.bio || "";
              currentRole = (res.data.role || "User").trim();
              roleCache[currentUser.toLowerCase()] = currentRole;
              localStorage.setItem("hx_comm_role", currentRole);
              localStorage.setItem("hx_roles_cache", JSON.stringify(roleCache));
              document.getElementById("nameDisplay").innerHTML =
                getEliteName(currentUser);
            });
        }
      }

      async function loadDMList() {
        const res = await fetch(`${SCRIPT_URL}?action=get_users`);
        const data = await res.json();
        allUsersData = data.data;
        filterUsers();
      }

      function filterUsers() {
        const query = document.getElementById("userSearch").value.toLowerCase();
        const container = document.getElementById("dm-list-container");
        container.innerHTML = allUsersData
          .filter(
            (u) =>
              u.username !== currentUser &&
              u.username.toLowerCase().includes(query)
          )
          .map((u) => {
            roleCache[u.username.toLowerCase()] = u.role;
            return `<div class="hx-card" style="display:flex; align-items:center; gap:12px; cursor:pointer;" onclick="startChat('${
              u.username
            }')">
            <img src="${
              u.pic || "https://ui-avatars.com/api/?name=" + u.username
            }" class="hx-pfp" style="width:35px; height:35px;">
            <b>${getEliteName(u.username)}</b>
        </div>`;
          })
          .join("");
        localStorage.setItem("hx_roles_cache", JSON.stringify(roleCache));
      }

      async function viewProfile(u) {
        if (u === currentUser) return openScreen("profile");
        viewTarget = u;
        openScreen("user-profile");
        document.getElementById("view-name").innerHTML = getEliteName(u);
        fetch(`${SCRIPT_URL}?action=get_user_data&uid=${u}`)
          .then((r) => r.json())
          .then((res) => {
            document.getElementById("view-pfp").src =
              res.data.pic || `https://ui-avatars.com/api/?name=${u}`;
            document.getElementById("view-bio").innerText =
              res.data.bio || "No bio.";
            roleCache[u.toLowerCase()] = (res.data.role || "User").trim();
            localStorage.setItem("hx_roles_cache", JSON.stringify(roleCache));
            document.getElementById("view-name").innerHTML = getEliteName(u);
          });
        const mySocial = await fetchStats(currentUser, null);
        document.getElementById("followBtn").innerText = (
          mySocial.followingList || []
        ).includes(viewTarget)
          ? "Unfollow"
          : "Follow";
        await fetchStats(u, "user-profile-stats");
      }

      async function deletePost(pid, author) {
        if (!confirm("Delete forever?")) return;
        document.getElementById(`post-${pid}`).style.display = "none";
        if (
          (currentRole === "Admin" || currentRole === "Owner") &&
          author !== currentUser
        ) {
          await fetch(SCRIPT_URL, {
            method: "POST",
            body: JSON.stringify({
              action: "dm",
              uid: currentUser,
              target: author,
              message:
                "*System Warning:* An admin has deleted your post. Please mind what you broadcast.",
            }),
          });
        }
        await fetch(SCRIPT_URL, {
          method: "POST",
          body: JSON.stringify({
            action: "delete_post",
            pid: pid,
            uid: currentUser,
          }),
        });
      }

      async function userAuth(mode) {
        let payload = {
          action: mode,
          username: document.getElementById(
            mode === "login" ? "logUser" : "sigUser"
          ).value,
          password: document.getElementById(
            mode === "login" ? "logPass" : "sigPass"
          ).value,
        };
        if (mode === "signup") {
          payload.email = document.getElementById("sigEmail").value;
          payload.pic = document.getElementById("sigPfp").value;
        }
        const r = await fetch(SCRIPT_URL, {
          method: "POST",
          body: JSON.stringify(payload),
        });
        const res = await r.json();
        if (res.status === "Success") {
          localStorage.setItem("hx_comm_user", res.data.username);
          localStorage.setItem(
            "hx_comm_role",
            (res.data.role || "User").trim()
          );
          location.reload();
        } else alert(res.data);
      }

      async function fetchStats(uid, elementId) {
        const r = await fetch(
          `${SCRIPT_URL}?action=get_social_stats&uid=${uid}`
        );
        const res = await r.json();
        if (elementId)
          document.getElementById(
            elementId
          ).innerHTML = `<div class="stat-card"><span class="stat-num">${
            res.data.followers || 0
          }</span>Followers</div><div class="stat-card"><span class="stat-num">${
            res.data.following || 0
          }</span>Following</div>`;
        return res.data;
      }

      async function toggleFollow() {
        const btn = document.getElementById("followBtn");
        btn.disabled = true;
        const res = await fetch(SCRIPT_URL, {
          method: "POST",
          body: JSON.stringify({
            action: "follow",
            uid: currentUser,
            target: viewTarget,
          }),
        });
        btn.innerText =
          (await res.json()).data === "Followed" ? "Unfollow" : "Follow";
        await fetchStats(viewTarget, "user-profile-stats");
        btn.disabled = false;
      }

      async function startChat(t) {
        viewTarget = t;
        openScreen("chat-view");
        document.getElementById("chat-target-name").innerHTML = getEliteName(t);
        loadDMs();
      }
      async function loadDMs() {
        const r = await fetch(
          `${SCRIPT_URL}?action=get_dms&uid=${currentUser}&target=${viewTarget}`
        );
        const res = await r.json();
        document.getElementById("chat-messages").innerHTML = res.data
          .map(
            (m) =>
              `<div style="text-align:${
                m[0] == currentUser ? "right" : "left"
              }; margin-bottom:10px;"><div style="display:inline-block; padding:8px 12px; border-radius:12px; background:${
                m[0] == currentUser ? "var(--primary)" : "var(--card)"
              }; color:${m[0] == currentUser ? "#000" : "#fff"}">${linkify(
                m[2]
              )}</div></div>`
          )
          .join("");
        document.getElementById("chat-messages").scrollTop =
          document.getElementById("chat-messages").scrollHeight;
      }

      async function sendDM() {
        const i = document.getElementById("msgInput");
        if (!i.value) return;
        await fetch(SCRIPT_URL, {
          method: "POST",
          body: JSON.stringify({
            action: "dm",
            uid: currentUser,
            target: viewTarget,
            message: i.value,
          }),
        });
        i.value = "";
        loadDMs();
      }

      function openComments(pid) {
        currentActivePost = pid;
        fetch(`${SCRIPT_URL}?action=get_feed`)
          .then((r) => r.json())
          .then((res) => {
            const p = res.data.find((x) => x.pid === pid);
            const list = document.getElementById("full-comment-list");
            list.innerHTML = p.recent_comments.length
              ? ""
              : "<p style='text-align:center; padding:40px; color:var(--muted)'>No comments.</p>";
            p.recent_comments.forEach((c) => {
              list.innerHTML += `<div class="comment-item"><b>${getEliteName(
                c.user
              )}</b><p>${linkify(c.text)}</p></div>`;
            });
            openScreen("comment-view");
          });
      }

      async function sendComment() {
        const input = document.getElementById("active-comment-input");
        if (!input.value) return;
        await fetch(SCRIPT_URL, {
          method: "POST",
          body: JSON.stringify({
            action: "comment",
            pid: currentActivePost,
            uid: currentUser,
            content: input.value,
          }),
        });
        input.value = "";
        openScreen("home");
      }

      async function submitBroadcast() {
        const t = document.getElementById("postText").value;
        const m = document.getElementById("imageUrlInput").value;
        document.getElementById("bg-loader").style.display = "block";
        await fetch(SCRIPT_URL, {
          method: "POST",
          body: JSON.stringify({
            action: "post",
            uid: currentUser,
            content: t,
            media: m,
          }),
        });
        location.reload();
      }

      function openScreen(id) {
        document
          .querySelectorAll(".screen")
          .forEach((s) => s.classList.remove("active"));
        document
          .querySelectorAll(".nav-item")
          .forEach((n) => n.classList.remove("active"));
        document.getElementById(id + "-screen").classList.add("active");
        document.getElementById("nav-" + id)?.classList.add("active");
        document
          .getElementById("mainFab")
          .classList.toggle("visible", id === "home");
        if (id === "home") loadFeed();
        if (id === "dm") loadDMList();
        if (id === "profile") checkUserStatus();
      }

      function logout() {
        localStorage.clear();
        location.reload();
      }
      function toggleAuthView(v) {
        document.getElementById("login-view").style.display =
          v === "login" ? "block" : "none";
        document.getElementById("signup-view").style.display =
          v === "signup" ? "block" : "none";
      }
      function sharePost(pid) {
        const url = `${window.location.origin}${window.location.pathname}?post=${pid}`;
        if (navigator.share) navigator.share({ title: "HX Post", url: url });
        else {
          navigator.clipboard.writeText(url);
          alert("Link copied!");
        }
      }

      if (currentUser) loadFeed();
      else openScreen("profile");
    </script>
  </body>
</html>
