<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HX Community | Social Gateway</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        :root {
            --bg:#020617; --surface:#0f172a; --card:rgba(30, 41, 59, 0.7); --border:#334155;
            --text:#f8fafc; --muted:#94a3b8; --primary:#38bdf8; --error:#ef4444; --accent:#818cf8;
            --header-h: 60px;
        }
        .light {
            --bg:#f8fafc; --surface:#ffffff; --card:rgba(255, 255, 255, 0.8); --border:#cbd5e1;
            --text:#0f172a; --muted:#64748b; --primary:#0284c7;
        }
        * { box-sizing: border-box; font-family: 'Inter', sans-serif; -webkit-user-select: none; user-select: none; }
        input, textarea { -webkit-user-select: text; user-select: text; border-radius: 12px; outline: none; transition: 0.2s; }
        body { margin: 0; background: var(--bg); color: var(--text); padding-bottom: 90px; transition: 0.3s; overflow-x: hidden; }
        
        /* Compact Header */
        header { 
            background: var(--surface); border-bottom: 1px solid var(--border); 
            display: flex; align-items: center; justify-content: space-between; 
            padding: 0 15px; height: var(--header-h); position: sticky; top: 0; z-index: 1000; backdrop-filter: blur(12px);
        }
        .logo { height: 24px; cursor: pointer; filter: drop-shadow(0 0 8px var(--primary)); }
        
        /* UI Components */
        .btn-process { pointer-events: none; opacity: 0.6; filter: grayscale(1); }
        .tag-list { display: flex; gap: 8px; overflow-x: auto; padding: 5px 0; margin-bottom: 10px; border-bottom: 1px solid var(--border); }
        .tag-pill { background: var(--primary); color: #000; padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: bold; white-space: nowrap; cursor: pointer; }

        .hx-card { background: var(--card); border: 1px solid var(--border); border-radius: 20px; padding: 15px; margin-bottom: 15px; }
        .hx-avatar { width: 40px; height: 40px; border-radius: 12px; background: var(--primary); display: flex; align-items: center; justify-content: center; font-weight: 800; border: 2px solid var(--primary); color: #000; overflow: hidden; }
        .hx-avatar img { width: 100%; height: 100%; object-fit: cover; }
        
        .hx-actions { display: flex; gap: 20px; margin-top: 10px; border-top: 1px solid var(--border); padding-top: 10px; }
        .hx-action { cursor: pointer; display: flex; align-items: center; gap: 5px; font-size: 14px; transition: 0.2s; }
        .hx-action.liked { color: var(--error); }
        .hx-action.liked i { animation: heartPop 0.3s ease; }
        @keyframes heartPop { 0% { transform: scale(1); } 50% { transform: scale(1.4); } 100% { transform: scale(1); } }

        /* Login UI */
        .auth-field { width: 100%; background: var(--surface); border: 1px solid var(--border); color: white; padding: 12px; margin-bottom: 10px; }
        .auth-btn { width: 100%; background: var(--primary); border: none; padding: 12px; border-radius: 12px; font-weight: bold; cursor: pointer; color: #000; }

        /* Floating Pencil */
        .fab { position: fixed; bottom: 100px; right: 20px; width: 56px; height: 56px; border-radius: 18px; background: var(--primary); color: #000; display: flex; align-items: center; justify-content: center; box-shadow: 0 8px 20px rgba(56, 189, 248, 0.4); z-index: 999; }
        .fab i.fa-plus { font-size: 12px; position: absolute; bottom: 14px; right: 14px; background: #000; color: var(--primary); border-radius: 50%; padding: 2px; }

        .nav-bar { position: fixed; bottom: 0; left: 0; right: 0; background: var(--surface); border-top: 1px solid var(--border); display: flex; justify-content: space-around; padding: 12px 0; z-index: 1000; }
        .nav-item { color: var(--muted); font-size: 20px; text-align: center; cursor: pointer; }
        .nav-item.active { color: var(--primary); }
        
        #hx-notifier { position: fixed; top: 70px; right: 15px; z-index: 9999; pointer-events: none; }
    </style>
</head>
<body>

<div id="hx-notifier"></div>

<header>
    <img src="logo1.png" class="logo" onclick="location.reload()">
    <div style="display:flex; gap:10px;">
        <button id="reloadBtn" onclick="location.reload()" style="background:var(--card); border:1px solid var(--border); color:var(--text); padding:6px 12px; border-radius:8px;">
            <i class="fas fa-redo-alt"></i> Reload
        </button>
        <div onclick="toggleTheme()" style="cursor:pointer; width:36px; height:36px; display:flex; align-items:center; justify-content:center; background:var(--card); border-radius:10px;">
            <i class="fas fa-moon" id="tIcon"></i>
        </div>
    </div>
</header>

<div class="fab" onclick="checkAuthGate('compose')">
    <i class="fas fa-pencil-alt"></i>
    <i class="fas fa-plus"></i>
</div>

<div class="main-container" style="max-width: 600px; margin: auto; padding: 15px;">
    
    <div id="search-section" style="margin-bottom: 15px;">
        <input type="text" id="globalSearch" placeholder="Search HX Network..." oninput="handleSearch(this.value)" style="width:100%; padding:12px; background:var(--card); border:1px solid var(--border); color:white; border-radius:25px;">
    </div>

    <div id="home-screen" class="screen active">
        <div id="feed"></div>
    </div>

    <div id="dm-screen" class="screen">
        <div id="dm-gate" style="display:none; text-align:center; padding:40px;">
            <i class="fas fa-lock" style="font-size:40px; color:var(--muted)"></i>
            <h3>Neural Link Locked</h3>
            <p>You must be authenticated to access private channels.</p>
            <button class="auth-btn" onclick="openScreen('profile')">Login to Access</button>
        </div>
        <div id="user-list-container">
            <h3 style="margin-top:0;">Active Nodes</h3>
            <div id="messenger-list"></div>
        </div>
    </div>

    <div id="compose-screen" class="screen">
        <h3>Create Broadcast</h3>
        <div id="mention-area" class="tag-list" style="display:none;"></div>
        <textarea id="postText" oninput="checkForMentions(this)" placeholder="Share a wave..." style="width:100%; min-height:150px; background:var(--card); border:1px solid var(--border); color:white; padding:15px;"></textarea>
        <div style="margin-top:15px; display:flex; justify-content:space-between; align-items:center;">
            <label for="postImg" style="cursor:pointer; color:var(--primary); font-size:14px;"><i class="fas fa-image"></i> Add Media</label>
            <input type="file" id="postImg" hidden onchange="uploadMedia(this)">
            <button id="broadcastBtn" onclick="submitPost()" class="auth-btn" style="width:auto; padding:10px 25px;">Broadcast</button>
        </div>
        <div id="postPreview"></div>
    </div>

    <div id="profile-screen" class="screen">
        <div id="auth-ui">
            <h3 id="authTitle">Network Authentication</h3>
            <input type="text" id="auth_user" class="auth-field" placeholder="Username">
            <input type="password" id="auth_pass" class="auth-field" placeholder="Password">
            <button id="loginBtn" class="auth-btn" onclick="handleAuth('login')">Login to HX</button>
            <p style="text-align:center; font-size:12px; margin:15px 0;">New to the network?</p>
            <button id="signupBtn" class="auth-btn" style="background:none; border:1px solid var(--primary); color:var(--primary);" onclick="handleAuth('signup')">Register Node</button>
        </div>
        
        <div id="profile-ui" style="display:none; text-align:center;">
            <div class="hx-avatar" id="myAvatar" style="width:80px; height:80px; margin:0 auto 15px; font-size:32px;">?</div>
            <h2 id="myUserDisplay">@User</h2>
            <p id="myBio" style="color:var(--muted)">Active Community Node</p>
            <button onclick="logout()" class="auth-btn" style="background:var(--error); color:white; margin-top:20px;">Disconnect Session</button>
        </div>
    </div>
</div>

<div class="nav-bar">
    <div class="nav-item active" id="nav-home" onclick="openScreen('home')"><i class="fas fa-home"></i></div>
    <div class="nav-item" id="nav-dm" onclick="openScreen('dm')"><i class="fas fa-comment-dots"></i></div>
    <div class="nav-item" onclick="window.location.href='templates.html'"><i class="fas fa-store"></i></div>
    <div class="nav-item" id="nav-profile" onclick="openScreen('profile')"><i class="fas fa-user-circle"></i></div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycby9eEtH55XibqVgBOPeANg7WKYL61MOQYeBuKJWOD5UTRGn4VeSMcGNeFsUkk3WyfRpeA/exec";
const AUTH_URL = "https://script.google.com/macros/s/AKfycbx7xeCXgINXt0bgVx5TMT-shfI3dKny7H-hn9po7iVD3kOzUsldOVCjFU8hLfGViFFAow/exec";

let currentUser = localStorage.getItem("hx_user");
let lastActionTime = 0;
let cachedUsers = [];
let postImgUrl = "";

// AUTO-REFRESH ON VISIBILITY
document.addEventListener("visibilitychange", () => {
    if (!document.hidden) loadFeed();
});

// AUTH GATE
function checkAuthGate(target) {
    if (!currentUser) {
        notify("Access Denied: Please Login", "error");
        openScreen('profile');
        return;
    }
    openScreen(target);
}

// LOGIN / SIGNUP LOGIC
async function handleAuth(type) {
    const user = document.getElementById("auth_user").value.trim();
    const pass = document.getElementById("auth_pass").value.trim();
    if (!user || !pass) return notify("Missing credentials", "error");

    const btn = type === 'login' ? document.getElementById("loginBtn") : document.getElementById("signupBtn");
    const originalText = btn.innerText;
    btn.innerText = type === 'login' ? "Authenticating..." : "Creating Node...";
    btn.classList.add("btn-process");

    try {
        const response = await fetch(`${AUTH_URL}?action=${type}&user=${user}&pass=${pass}`);
        const result = await response.text();

        if (result.includes("Success")) {
            localStorage.setItem("hx_user", user);
            currentUser = user;
            notify(`Welcome back, @${user}`);
            location.reload();
        } else {
            notify(result, "error");
        }
    } catch (e) { notify("Network Error", "error"); }
    
    btn.innerText = originalText;
    btn.classList.remove("btn-process");
}

// FEED & LIKES
async function loadFeed() {
    try {
        const r = await fetch(API_URL + "?action=get_feed");
        const res = await r.json();
        const feed = document.getElementById("feed");
        feed.innerHTML = res.data.reverse().map(p => {
            const latestComms = (p.recent_comments || []).slice(0, 3).map(c => `
                <div style="font-size:12px; margin-top:4px;"><b>@${c.user}</b>: ${c.text}</div>
            `).join("");

            return `
            <div class="hx-card">
                <div class="hx-header" style="display:flex; gap:10px; align-items:center; margin-bottom:10px;">
                    <div class="hx-avatar">${p.pic ? `<img src="${p.pic}">` : p.author[0].toUpperCase()}</div>
                    <div class="hx-username">@${p.author}</div>
                </div>
                <div class="hx-content">${p.content}</div>
                ${p.media ? `<img src="${p.media}" class="hx-media" style="width:100%; border-radius:15px; margin:10px 0;">` : ''}
                <div class="hx-actions">
                    <div class="hx-action" id="like-${p.pid}" onclick="handleLike('${p.pid}')">
                        <i class="far fa-heart"></i> <span id="count-${p.pid}">${p.likes || 0}</span>
                    </div>
                    <div class="hx-action" onclick="toggleComments('${p.pid}')">
                        <i class="far fa-comment"></i> ${p.comment_count || 0}
                    </div>
                </div>
                <div id="comm-sec-${p.pid}" style="margin-top:10px; border-top:1px solid var(--border); padding-top:10px;">
                    ${latestComms}
                    <div id="full-comms-${p.pid}" style="display:none;"></div>
                    <div style="display:flex; gap:8px; margin-top:8px;">
                        <input type="text" id="in-${p.pid}" placeholder="Reply..." style="flex:1; padding:8px; background:var(--bg); border:1px solid var(--border); font-size:12px; color:white;">
                        <button onclick="postComment('${p.pid}')" style="background:var(--primary); border:none; border-radius:8px; padding:0 12px; font-size:12px;">Send</button>
                    </div>
                </div>
            </div>`;
        }).join("");
    } catch(e) {}
}

// INTERACTIVE LIKE (Instant UI change)
async function handleLike(pid) {
    if (!currentUser) return notify("Login to like posts", "error");
    const el = document.getElementById(`like-${pid}`);
    const countEl = document.getElementById(`count-${pid}`);
    
    // UI Change First
    el.classList.add("liked");
    el.querySelector("i").className = "fas fa-heart";
    countEl.innerText = parseInt(countEl.innerText) + 1;

    try {
        const res = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "like", pid, uid: currentUser }) });
        if (!(await res.json()).status === "Success") throw new Error();
    } catch (e) {
        // Revert if error
        el.classList.remove("liked");
        el.querySelector("i").className = "far fa-heart";
        countEl.innerText = parseInt(countEl.innerText) - 1;
        notify("Update Failed", "error");
    }
}

// MENTION SYSTEM (@ Feature)
function checkForMentions(input) {
    const val = input.value;
    const lastAt = val.lastIndexOf("@");
    const area = document.getElementById("mention-area");
    
    if (lastAt !== -1 && (lastAt === 0 || val[lastAt - 1] === " ")) {
        area.style.display = "flex";
        area.innerHTML = cachedUsers.map(u => `
            <div class="tag-pill" onclick="insertTag('${u.username}')">@${u.username}</div>
        `).join("");
    } else {
        area.style.display = "none";
    }
}

function insertTag(user) {
    const input = document.getElementById("postText");
    const val = input.value;
    const lastAt = val.lastIndexOf("@");
    input.value = val.substring(0, lastAt) + "@" + user + " ";
    document.getElementById("mention-area").style.display = "none";
    input.focus();
}

async function uploadMedia(input) {
    const btn = document.getElementById("broadcastBtn");
    btn.classList.add("btn-process");
    btn.innerText = "Processing Media...";
    
    // Using simple ImgBB as primary for speed
    let fd = new FormData();
    fd.append("image", input.files[0]);
    try {
        const r = await fetch("https://api.imgbb.com/1/upload?key=363e1d13f890947704153097c5586616", { method: "POST", body: fd });
        const res = await r.json();
        postImgUrl = res.data.url;
        document.getElementById("postPreview").innerHTML = `<img src="${postImgUrl}" style="width:60px; height:60px; border-radius:8px;">`;
        notify("Media Attached");
    } catch(e) { notify("Upload Error", "error"); }
    
    btn.classList.remove("btn-process");
    btn.innerText = "Broadcast";
}

function openScreen(name) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    document.getElementById(name + '-screen').classList.add('active');
    document.getElementById('nav-' + name)?.classList.add('active');

    if (name === 'profile') {
        if (currentUser) {
            document.getElementById("auth-ui").style.display = "none";
            document.getElementById("profile-ui").style.display = "block";
            document.getElementById("myUserDisplay").innerText = "@" + currentUser;
            document.getElementById("myAvatar").innerText = currentUser[0].toUpperCase();
        }
    }
    
    if (name === 'dm') {
        if (!currentUser) {
            document.getElementById("dm-gate").style.display = "block";
            document.getElementById("user-list-container").style.display = "none";
        } else {
            document.getElementById("dm-gate").style.display = "none";
            document.getElementById("user-list-container").style.display = "block";
            loadMessenger();
        }
    }
}

async function loadMessenger() {
    const r = await fetch(API_URL + "?action=get_users");
    const res = await r.json();
    cachedUsers = res.data;
    document.getElementById("messenger-list").innerHTML = res.data.map(u => `
        <div class="hx-card" style="display:flex; align-items:center; gap:10px; padding:10px; margin-bottom:8px;">
            <div class="hx-avatar">${u.pic ? `<img src="${u.pic}">` : u.username[0].toUpperCase()}</div>
            <div>@${u.username}</div>
            <button onclick="notify('Initializing Chat...')" style="margin-left:auto; background:var(--primary); border:none; border-radius:8px; padding:5px 10px; font-size:12px;">Link</button>
        </div>
    `).join("");
}

function notify(text, type="primary") {
    const el = document.createElement("div");
    el.className = "hx-toast";
    el.style.borderLeftColor = type === "error" ? "var(--error)" : "var(--primary)";
    el.innerHTML = `<i class="fas fa-bolt"></i><span>${text}</span>`;
    document.getElementById("hx-notifier").prepend(el);
    setTimeout(() => { el.classList.add('out'); setTimeout(() => el.remove(), 500); }, 3000);
}

function toggleTheme() { document.body.classList.toggle("light"); }
function logout() { localStorage.clear(); location.reload(); }

// Initial App State
if (currentUser) loadFeed();
else openScreen('home');
loadFeed();
loadMessenger(); // Cache users for tagging
</script>
</body>
</html>
