<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HX - Community Feed</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        :root { --bg: #020617; --surface: #0f172a; --card: #1e293b; --border: #334155; --text: #f8fafc; --muted: #94a3b8; --primary: #38bdf8; --error: #ef4444; --admin: #60a5fa; --owner: #f87171; --success: #22c55e; }
        * { box-sizing: border-box; font-family: "Inter", sans-serif; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: var(--text); padding-bottom: 80px; overflow-x: hidden; }
        
        body.is-working { pointer-events: none; opacity: 0.8; }
        header { background: rgba(15, 23, 42, 0.95); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 15px; height: 50px; position: sticky; top: 0; z-index: 1000; backdrop-filter: blur(10px); }
        .logo { height: 22px; cursor: pointer; }
        .screen { padding: 15px; max-width: 600px; margin: 0 auto; display: none; }
        .screen.active { display: block !important; }

        /* SKELETON LOADERS */
        .img-wrapper { background: rgba(56, 189, 248, 0.1); position: relative; overflow: hidden; border-radius: 8px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; }
        .img-wrapper.is-loaded { background: transparent !important; }
        .img-wrapper.is-loaded::after { display: none !important; }
        .img-wrapper::after { content: ""; position: absolute; inset: 0; background: linear-gradient(90deg, transparent, rgba(56, 189, 248, 0.2), transparent); animation: shimmer 1.5s infinite; }
        @keyframes shimmer { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }
        .media-item, .hx-pfp { opacity: 0; transition: opacity 0.4s ease-in; width: 100%; height: 100%; object-fit: cover; }
        .loaded { opacity: 1 !important; }

        /* RESTORED ELITE UI ANIMATIONS */
        .name-owner { color: var(--owner) !important; text-shadow: 0 0 10px rgba(248, 113, 113, 0.4); font-weight: 800 !important; animation: ownerGlow 2s infinite ease-in-out; }
        .name-admin { color: var(--admin) !important; text-shadow: 0 0 10px rgba(96, 165, 250, 0.4); font-weight: 700 !important; }
        @keyframes ownerGlow { 0%, 100% { filter: brightness(1); } 50% { filter: brightness(1.3); } }

        /* SPIKED VERIFIED BADGE */
        .badge-spiked { position: relative; display: inline-flex; align-items: center; justify-content: center; margin-left: 4px; color: var(--primary); font-size: 12px; filter: drop-shadow(0 0 5px rgba(56, 189, 248, 0.6)); vertical-align: middle; }
        .badge-spiked i.fa-certificate { font-size: 16px; }
        .badge-spiked i.fa-check { position: absolute; font-size: 8px; color: #000; font-weight: 900; }

        /* POST CARDS */
        .hx-card { background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 15px; margin-bottom: 12px; position: relative; }
        .hx-user-row { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; cursor: pointer; width: fit-content; }
        .hx-pfp { width: 40px; height: 40px; border-radius: 12px; border: 1px solid var(--border); }

        .media-container { position: relative; width: 100%; margin-top: 10px; border-radius: 12px; overflow: hidden; border: 1px solid var(--border); background: #000; }
        .media-scroller { display: flex; overflow-x: auto; scroll-snap-type: x mandatory; scrollbar-width: none; scroll-behavior: smooth; height: 320px; }
        .media-scroller .img-wrapper { min-width: 100%; height: 100%; border-radius: 0; }
        .media-item { object-fit: cover; cursor: pointer; }
        .media-counter { position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.7); padding: 3px 8px; border-radius: 12px; font-size: 10px; color: #fff; z-index: 5; font-weight: bold; }

        /* FULL VIEW OVERLAY WITH ARROW */
        #media-overlay { position: fixed; inset: 0; background: black; z-index: 5000; display: none; align-items: center; justify-content: center; flex-direction: column; }
        #overlay-content { max-width: 100%; max-height: 90vh; object-fit: contain; }
        .close-overlay-btn { position: absolute; top: 20px; left: 20px; color: white; font-size: 24px; cursor: pointer; background: rgba(255,255,255,0.1); width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; z-index: 5001; }

        /* ACTIONS */
        .hx-action { cursor: pointer; display: inline-flex; align-items: center; gap: 6px; margin-right: 20px; color: var(--muted); transition: 0.2s; }
        .hx-action.liked { color: var(--error) !important; }
        .hx-action.liked i { font-weight: 900; }

        /* NAV BAR */
        .nav-bar { position: fixed; bottom: 0; left: 0; right: 0; background: var(--surface); border-top: 1px solid var(--border); display: flex; justify-content: space-around; padding: 14px 0; z-index: 1000; }
        .nav-item { color: var(--muted); font-size: 20px; cursor: pointer; }
        .nav-item.active { color: var(--primary); }
        .fab { position: fixed; bottom: 90px; right: 20px; width: 55px; height: 55px; border-radius: 18px; background: var(--primary); color: #000; display: flex; align-items: center; justify-content: center; font-size: 22px; cursor: pointer; z-index: 999; box-shadow: 0 4px 15px rgba(56, 189, 248, 0.4); }
        
        .hx-input { width: 100%; background: #0f172a; border: 1px solid var(--border); color: white; padding: 12px; border-radius: 12px; outline: none; margin-bottom: 10px; }
        #bg-loader { position: fixed; top: 65px; left: 50%; transform: translateX(-50%); background: var(--primary); color: #000; padding: 8px 20px; border-radius: 30px; font-size: 12px; font-weight: bold; z-index: 2000; display: none; }
        
        /* PREVIEW COLLAGE */
        .collage-item { position: relative; width: 100%; height: 80px; }
        .collage-del { position: absolute; top: 2px; right: 2px; background: var(--error); color: white; border: none; border-radius: 50%; width: 18px; height: 18px; font-size: 10px; cursor: pointer; }
    </style>
</head>
<body id="main-body">
    <div id="bg-loader">SYNCING...</div>
    
    <div id="media-overlay">
        <div class="close-overlay-btn" onclick="document.getElementById('media-overlay').style.display='none'"><i class="fas fa-arrow-left"></i></div>
        <img id="overlay-content" src="">
    </div>
    
    <header>
        <img src="logo1.png" class="logo" onclick="openScreen('feed')">
        <i class="fas fa-sync-alt" style="color: var(--primary); cursor: pointer" onclick="loadFeed()"></i>
    </header>

    <div id="feed-screen" class="screen active"><div id="feed-container"></div></div>

    <div id="comment-screen" class="screen">
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px;"><i class="fas fa-arrow-left" onclick="openScreen('feed')" style="cursor:pointer"></i><h3>Comments</h3></div>
        <div id="full-comment-list" style="margin-bottom: 100px"></div>
        <div style="position: fixed; bottom: 75px; left: 0; right: 0; padding: 15px; background: var(--surface); border-top: 1px solid var(--border);">
            <div style="display: flex; gap: 8px; max-width: 600px; margin: 0 auto">
                <input type="text" id="active-comment-input" class="hx-input" style="margin:0" placeholder="Write a comment...">
                <button onclick="sendComment()" style="width: 80px; padding: 12px; background: var(--primary); border:none; border-radius:12px; font-weight:bold; cursor:pointer;">Post</button>
            </div>
        </div>
    </div>

    <div id="compose-screen" class="screen">
        <div style="display:flex; align-items:center; gap:12px; margin-bottom:20px;"><i class="fas fa-arrow-left" onclick="openScreen('feed')" style="cursor:pointer"></i><h3>New Broadcast</h3></div>
        <textarea id="postText" class="hx-input" style="height: 120px" placeholder="What's happening?"></textarea>
        <input type="file" id="postFile" accept="image/*" multiple hidden onchange="handleMultiUpload(this)">
        <button class="hx-input" style="background:transparent; border:1px solid var(--border); color:var(--muted)" onclick="document.getElementById('postFile').click()"><i class="fas fa-images"></i> Add Media</button>
        <div id="collage-preview-box" style="display:grid; grid-template-columns:repeat(3,1fr); gap:8px; margin-top:10px;"></div>
        <button onclick="submitPost()" style="background:var(--primary); color:#000; border:none; padding:15px; border-radius:12px; width:100%; font-weight:bold; margin-top:10px; cursor:pointer;">Broadcast Now</button>
    </div>

    <div class="fab" id="fab-plus" onclick="openScreen('compose')"><i class="fas fa-plus"></i></div>

    <nav class="nav-bar">
        <div class="nav-item active" id="nav-home" onclick="openScreen('feed')"><i class="fas fa-home"></i></div>
        <div class="nav-item" id="nav-dm" onclick="location.href='messages.html'"><i class="fas fa-comments"></i></div>
        <div class="nav-item" id="nav-profile" onclick="location.href='profile.html'"><i class="fas fa-user-circle"></i></div>
    </nav>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxgjbIKQJUn5Tdo3r5KbmNQPU-ntffm2hJrw2PrsiqCKf8wa8wzpH-0m_h9nLpcc-JWwg/exec";
        let currentUser = localStorage.getItem("hx_comm_user"), currentRole = localStorage.getItem("hx_comm_role") || "User";
        let likedPosts = JSON.parse(localStorage.getItem("hx_comm_liked") || "[]"), roleCache = JSON.parse(localStorage.getItem("hx_roles_cache") || "{}");
        let mediaUrls = [], activePid = "", cachedFeedData = [];

        function setTaskState(working) {
            document.getElementById('main-body').classList.toggle('is-working', working);
            document.getElementById('bg-loader').style.display = working ? 'block' : 'none';
        }

        function handleImgLoad(el) { el.classList.add('loaded'); const wrapper = el.closest('.img-wrapper'); if (wrapper) wrapper.classList.add('is-loaded'); }

        function linkify(text) {
            if(!text) return "";
            return text.replace(/\*(.*?)\*/g, "<b>$1</b>").replace(/_(.*?)_/g, "<i>$1</i>")
                       .replace(/@(\w+)/g, (m, u) => `<span style="color:var(--primary); font-weight:bold" onclick="location.href='profile.html?user=${u}'">@${u}</span>`);
        }

        async function loadFeed() {
            setTaskState(true);
            try {
                const r = await fetch(`${SCRIPT_URL}?action=get_feed`);
                const res = await r.json();
                cachedFeedData = res.data;
                const container = document.getElementById("feed-container");
                container.innerHTML = "";
                cachedFeedData.forEach(p => {
                    roleCache[p.author.toLowerCase()] = p.role;
                    let mediaHtml = "";
                    if (p.media) {
                        const urls = p.media.split(',');
                        mediaHtml = `<div class="media-container">${urls.length > 1 ? `<div class="media-counter">1/${urls.length}</div>` : ''}<div class="media-scroller">${urls.map(u => `<div class="img-wrapper"><img src="${u}" class="media-item" onload="handleImgLoad(this)" onclick="viewFull('${u}')"></div>`).join('')}</div></div>`;
                    }
                    const pfp = p.pic || `https://ui-avatars.com/api/?name=${p.author}`;
                    const isLkd = likedPosts.includes(p.pid);
                    const card = document.createElement("div"); card.className = "hx-card";
                    card.innerHTML = `<div style="position:absolute; top:18px; right:15px; display:flex; gap:15px;"><i class="fas fa-share hx-util-btn" onclick="sharePost('${p.pid}')"></i><i class="fas fa-paper-plane hx-util-btn" onclick="location.href='messages.html?chat=${p.author}'"></i>${(currentRole==='Admin'||currentRole==='Owner'||p.author===currentUser)?`<i class="fas fa-trash hx-util-btn" style="color:var(--error)" onclick="deletePost('${p.pid}')"></i>`:''}</div><div class="hx-user-row" onclick="location.href='profile.html?user=${p.author}'"><div class="img-wrapper" style="width:40px; height:40px; border-radius:12px;"><img src="${pfp}" class="hx-pfp" onload="handleImgLoad(this)"></div><b>${getEliteName(p.author)}</b></div><div style="white-space:pre-wrap; margin-bottom:5px;">${linkify(p.content)}</div>${mediaHtml}<div style="margin-top:15px; display:flex; gap:25px; border-top:1px solid rgba(255,255,255,0.05); padding-top:10px;"><span class="hx-action ${isLkd?'liked':''}" onclick="doLike('${p.pid}', this)"><i class="${isLkd?'fas':'far'} fa-heart"></i> <span class="like-count">${p.likes}</span></span><span class="hx-action" onclick="openComments('${p.pid}')"><i class="far fa-comment"></i> ${p.comment_count}</span></div>`;
                    container.appendChild(card);
                });
                localStorage.setItem("hx_roles_cache", JSON.stringify(roleCache));
            } catch(e) { console.error(e); }
            setTaskState(false);
        }

        function openComments(pid) {
            activePid = pid;
            openScreen('comment');
            const post = cachedFeedData.find(x => x.pid === pid);
            const container = document.getElementById("full-comment-list");
            if (!post || !post.recent_comments || post.recent_comments.length === 0) {
                container.innerHTML = "<p style='text-align:center; padding:40px; color:var(--muted)'>No comments yet.</p>";
                return;
            }
            container.innerHTML = post.recent_comments.map(c => `
                <div style="display:flex; gap:10px; margin-bottom:15px; border-bottom: 1px solid var(--border); padding-bottom:10px;">
                    <img src="https://ui-avatars.com/api/?name=${c.user}" style="width:32px; height:32px; border-radius:8px;">
                    <div style="flex:1"><b>${getEliteName(c.user)}</b><div style="font-size:14px; color:#e2e8f0; margin-top:2px;">${linkify(c.text)}</div></div>
                </div>`).join("");
        }

        async function handleMultiUpload(f) { 
            setTaskState(true); 
            document.getElementById('bg-loader').innerText = "SYNCING MEDIA...";
            for (let file of f.files) { 
                const fd = new FormData(); 
                fd.append("reqtype", "fileupload"); 
                fd.append("fileToUpload", file); 
                try { 
                    const r = await fetch("https://api.allorigins.win/raw?url=" + encodeURIComponent("https://catbox.moe/user/api.php"), { method: "POST", body: fd }); 
                    const url = (await r.text()).trim(); 
                    if(url.startsWith("https")) {
                        mediaUrls.push(url); 
                        const div = document.createElement('div'); div.className = 'collage-item img-wrapper';
                        div.innerHTML = `<img src="${url}" style="width:100%; height:100%; object-fit:cover; border-radius:8px;" onload="handleImgLoad(this)"><button class="collage-del" onclick="this.parentElement.remove(); mediaUrls=mediaUrls.filter(u=>u!=='${url}')">Ã—</button>`;
                        document.getElementById('collage-preview-box').appendChild(div);
                    }
                } catch(e) { console.error(e); }
            } 
            document.getElementById('bg-loader').innerText = "PROCESSING...";
            setTaskState(false); 
        }

        async function doLike(p, b) { 
            if(likedPosts.includes(p)) return; 
            likedPosts.push(p); 
            localStorage.setItem("hx_comm_liked", JSON.stringify(likedPosts)); 
            b.classList.add("liked"); 
            b.querySelector('i').className = "fas fa-heart";
            let c = b.querySelector('.like-count'); c.innerText = parseInt(c.innerText)+1; 
            await fetch(SCRIPT_URL, { method: "POST", body: JSON.stringify({ action: "like", pid: p, uid: currentUser }) }); 
        }

        async function sendComment() {
            const val = document.getElementById("active-comment-input").value.trim();
            if(!val) return;
            setTaskState(true);
            await fetch(SCRIPT_URL, { method: "POST", body: JSON.stringify({ action: "comment", pid: activePid, uid: currentUser, content: val }) });
            document.getElementById("active-comment-input").value = "";
            await loadFeed();
            openComments(activePid);
            setTaskState(false);
        }

        function getEliteName(u) { 
            const r = (roleCache[u.toLowerCase()] || "User").trim(); 
            let icon = r === "Owner" ? `<span class="badge-spiked"><i class="fas fa-certificate"></i><i class="fas fa-check"></i></span>` : (r === "Admin" ? ' <i class="fas fa-shield-alt"></i>' : '');
            let cls = r === "Owner" ? "name-owner" : (r === "Admin" ? "name-admin" : "");
            return `<span class="${cls}">@${u}${icon}</span>`; 
        }

        function viewFull(url) { document.getElementById('overlay-content').src = url; document.getElementById('media-overlay').style.display = 'flex'; }
        function sharePost(pid) { navigator.clipboard.writeText(window.location.origin + window.location.pathname + "?post=" + pid); alert("Link Copied!"); }
        function openScreen(id) { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); document.getElementById(id + '-screen').classList.add('active'); }
        async function submitPost() { const t = document.getElementById("postText").value; if(!t && mediaUrls.length === 0) return; setTaskState(true); await fetch(SCRIPT_URL, { method: "POST", body: JSON.stringify({ action: "post", uid: currentUser, content: t, media: mediaUrls.join(',') }) }); location.reload(); }
        async function deletePost(pid) { if(!confirm("Delete?")) return; setTaskState(true); await fetch(SCRIPT_URL, { method: "POST", body: JSON.stringify({ action: "delete_post", pid: pid, uid: currentUser }) }); location.reload(); }

        loadFeed();
    </script>
</body>
</html>