<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HX - Profile</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        :root { --bg: #020617; --surface: #0f172a; --card: #1e293b; --border: #334155; --text: #f8fafc; --muted: #94a3b8; --primary: #38bdf8; --error: #ef4444; --admin: #60a5fa; --owner: #f87171; --success: #22c55e; }
        * { box-sizing: border-box; font-family: "Inter", sans-serif; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: var(--text); padding-bottom: 80px; text-align: center; overflow-x: hidden; }
        
        .screen { padding: 40px 20px; max-width: 600px; margin: 0 auto; display: none; }
        .screen.active { display: block; }
        
        /* ELITE UI & SPIKED BADGE */
        .name-owner { color: var(--owner) !important; text-shadow: 0 0 10px rgba(248, 113, 113, 0.4); font-weight: 800 !important; animation: ownerGlow 2s infinite ease-in-out; }
        .name-admin { color: var(--admin) !important; text-shadow: 0 0 10px rgba(96, 165, 250, 0.4); font-weight: 700 !important; }
        @keyframes ownerGlow { 0%, 100% { filter: brightness(1); } 50% { filter: brightness(1.3); } }

        .badge-spiked { position: relative; display: inline-flex; align-items: center; justify-content: center; margin-left: 6px; color: var(--primary); font-size: 14px; filter: drop-shadow(0 0 5px rgba(56, 189, 248, 0.6)); vertical-align: middle; }
        .badge-spiked i.fa-certificate { font-size: 18px; }
        .badge-spiked i.fa-check { position: absolute; font-size: 9px; color: #000; font-weight: 900; }

        /* BLUE SKELETON LOADING */
        .img-wrapper { background: rgba(56, 189, 248, 0.1); position: relative; overflow: hidden; border-radius: 25px; width: 100px; height: 100px; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center; border: 3px solid var(--primary); }
        .img-wrapper.is-loaded { background: transparent; }
        .img-wrapper.is-loaded::after { display: none; }
        .img-wrapper::after { content: ""; position: absolute; inset: 0; background: linear-gradient(90deg, transparent, rgba(56, 189, 248, 0.2), transparent); animation: shimmer 1.5s infinite; }
        @keyframes shimmer { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }
        .hx-pfp { opacity: 0; transition: opacity 0.4s ease-in; width: 100%; height: 100%; object-fit: cover; }
        .loaded { opacity: 1 !important; }

        .hx-input { width: 100%; background: #0f172a; border: 1px solid var(--border); color: white; padding: 14px; border-radius: 12px; margin-bottom: 12px; outline: none; }
        .hx-btn { background: var(--primary); color: #000; border: none; padding: 14px; border-radius: 12px; font-weight: bold; width: 100%; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .hx-btn:active { transform: scale(0.98); opacity: 0.8; }
        .hx-btn.outline { background: transparent; border: 1px solid var(--primary); color: var(--primary); margin-bottom: 10px; }
        
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin: 20px 0; }
        .stat-card { background: rgba(255, 255, 255, 0.05); padding: 15px; border-radius: 15px; border: 1px solid var(--border); }
        .stat-card b { font-size: 20px; color: var(--primary); }

        .nav-bar { position: fixed; bottom: 0; left: 0; right: 0; background: var(--surface); border-top: 1px solid var(--border); display: flex; justify-content: space-around; padding: 14px 0; z-index: 1000; }
        .nav-item { color: var(--muted); font-size: 20px; cursor: pointer; }
        .nav-item.active { color: var(--primary); }
        #bg-loader { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: var(--primary); color: #000; padding: 8px 20px; border-radius: 30px; font-size: 12px; font-weight: bold; z-index: 2000; display: none; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5); }
    </style>
</head>
<body>
    <div id="bg-loader">SYNCING...</div>

    <div id="auth-screen" class="screen">
        <div id="login-view">
            <h2 style="margin-bottom: 20px">Login to HX</h2>
            <input type="text" id="logUser" class="hx-input" placeholder="Username">
            <input type="password" id="logPass" class="hx-input" placeholder="Password">
            <button class="hx-btn" onclick="userAuth('login')">Access Account</button>
            <p style="margin-top: 20px; color: var(--muted); cursor: pointer" onclick="toggleAuth('signup')">New here? <b>Create Account</b></p>
        </div>
        <div id="signup-view" style="display: none">
            <h2 style="margin-bottom: 20px">Join Community</h2>
            <input type="text" id="sigUser" class="hx-input" placeholder="Username">
            <input type="email" id="sigEmail" class="hx-input" placeholder="Email Address">
            <input type="password" id="sigPass" class="hx-input" placeholder="Create Password">
            <button class="hx-btn" onclick="userAuth('signup')">Register Now</button>
            <p style="margin-top: 20px; color: var(--muted); cursor: pointer" onclick="toggleAuth('login')">Have account? <b>Login</b></p>
        </div>
    </div>

    <div id="profile-screen" class="screen">
        <div class="img-wrapper">
            <img id="myPfp" class="hx-pfp" src="" onload="handleImgLoad(this)" />
        </div>
        <h2 id="myName"></h2>
        <p id="myBio" style="color: var(--muted); margin: 10px 0 20px; font-size: 14px; min-height: 20px;"></p>

        <div class="stats-grid">
            <div class="stat-card"><b id="stat-followers">0</b><br /><small style="color: var(--muted)">Followers</small></div>
            <div class="stat-card"><b id="stat-following">0</b><br /><small style="color: var(--muted)">Following</small></div>
        </div>

        <div id="social-controls" style="display: none; gap: 10px; margin-bottom: 20px">
            <button class="hx-btn" id="followBtn" onclick="doFollow()">Follow</button>
            <button class="hx-btn outline" id="msgBtn"><i class="fas fa-comment"></i> Message</button>
        </div>

        <div id="edit-controls" style="display: none; border-top: 1px solid var(--border); padding-top: 20px; margin-top: 10px;">
            <input type="text" id="newBio" class="hx-input" placeholder="Write something about yourself...">
            <input type="file" id="updatePfpFile" accept="image/*" style="display: none" onchange="uploadPfp(this)" />
            <button class="hx-btn outline" onclick="document.getElementById('updatePfpFile').click()"><i class="fas fa-camera"></i> Change Picture</button>
            <button class="hx-btn" onclick="saveProfile()"><i class="fas fa-save"></i> Save Changes</button>
            <button class="hx-btn" style="background: var(--error); color: white; margin-top: 30px" onclick="logout()">Logout</button>
        </div>
    </div>

    <nav class="nav-bar">
        <div class="nav-item" onclick="location.href='community.html'"><i class="fas fa-home"></i></div>
        <div class="nav-item" onclick="location.href='messages.html'"><i class="fas fa-comments"></i></div>
        <div class="nav-item active"><i class="fas fa-user-circle"></i></div>
    </nav>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxgjbIKQJUn5Tdo3r5KbmNQPU-ntffm2hJrw2PrsiqCKf8wa8wzpH-0m_h9nLpcc-JWwg/exec";
        let currentUser = localStorage.getItem("hx_comm_user");
        let roleCache = JSON.parse(localStorage.getItem("hx_roles_cache") || "{}");
        let viewTarget = new URLSearchParams(window.location.search).get("user") || currentUser;

        function handleImgLoad(el) { el.classList.add("loaded"); const wrapper = el.closest(".img-wrapper"); if (wrapper) wrapper.classList.add("is-loaded"); }

        function getEliteName(u) {
            const r = (roleCache[u.toLowerCase()] || "User").trim();
            let icon = "";
            if (r === "Owner") icon = `<span class="badge-spiked"><i class="fas fa-certificate"></i><i class="fas fa-check"></i></span>`;
            else if (r === "Admin") icon = ' <i class="fas fa-shield-alt"></i>';
            let cls = r === "Owner" ? "name-owner" : r === "Admin" ? "name-admin" : "";
            return `<span class="${cls}">@${u}${icon}</span>`;
        }

        async function loadProfile() {
            if (!currentUser && !new URLSearchParams(window.location.search).get("user")) {
                document.getElementById("auth-screen").classList.add("active");
                return;
            }
            document.getElementById("profile-screen").classList.add("active");

            if (viewTarget.toLowerCase() !== currentUser.toLowerCase()) {
                document.getElementById("social-controls").style.display = "flex";
                document.getElementById("msgBtn").onclick = () => (location.href = `messages.html?chat=${viewTarget}`);
            } else {
                document.getElementById("edit-controls").style.display = "block";
            }

            try {
                const r = await fetch(`${SCRIPT_URL}?action=get_user_data&uid=${viewTarget}`);
                const res = await r.json();
                if (res.status === "Success") {
                    roleCache[viewTarget.toLowerCase()] = res.data.role;
                    document.getElementById("myName").innerHTML = getEliteName(viewTarget);
                    document.getElementById("myBio").innerText = res.data.bio || "No bio yet.";
                    // FIXED: Removed G_PROXY, loading directly
                    document.getElementById("myPfp").src = res.data.pic || `https://ui-avatars.com/api/?name=${viewTarget}&background=random`;
                    if (viewTarget.toLowerCase() === currentUser.toLowerCase()) document.getElementById("newBio").value = res.data.bio || "";
                }

                const s = await fetch(`${SCRIPT_URL}?action=get_social_stats&uid=${viewTarget}`);
                const sres = await s.json();
                document.getElementById("stat-followers").innerText = sres.data.followers || 0;
                document.getElementById("stat-following").innerText = sres.data.following || 0;

                // FIXED: Direct following list comparison
                if (viewTarget.toLowerCase() !== currentUser.toLowerCase() && currentUser) {
                    const myStatsReq = await fetch(`${SCRIPT_URL}?action=get_social_stats&uid=${currentUser}`);
                    const myStats = await myStatsReq.json();
                    const followBtn = document.getElementById("followBtn");
                    const list = myStats.data.followingList || [];
                    
                    if (list.some(name => name.toLowerCase() === viewTarget.toLowerCase())) {
                        followBtn.innerText = "Following";
                        followBtn.style.background = "var(--surface)";
                        followBtn.style.border = "1px solid var(--border)";
                        followBtn.style.color = "var(--muted)";
                    } else {
                        followBtn.innerText = "Follow";
                        followBtn.style.background = "var(--primary)";
                        followBtn.style.color = "#000";
                        followBtn.style.border = "none";
                    }
                }
            } catch (e) { console.error("Load error", e); }
        }

        async function uploadPfp(f) {
            const fd = new FormData();
            fd.append("reqtype", "fileupload");
            fd.append("fileToUpload", f.files[0]);
            document.getElementById("bg-loader").style.display = "block";
            document.getElementById("bg-loader").innerText = "UPLOADING...";

            try {
                const r = await fetch("https://corsproxy.io/?" + encodeURIComponent("https://catbox.moe/user/api.php"), { method: "POST", body: fd });
                const url = await r.text();
                localStorage.setItem("hx_pfp_temp", url.trim());
                document.getElementById("myPfp").src = url.trim();
                document.getElementById("bg-loader").innerText = "UPLOADED! âœ…";
                setTimeout(() => (document.getElementById("bg-loader").style.display = "none"), 1000);
            } catch (e) { alert("Upload failed."); document.getElementById("bg-loader").style.display = "none"; }
        }

        async function saveProfile() {
            const bio = document.getElementById("newBio").value;
            const pic = localStorage.getItem("hx_pfp_temp") || "";
            document.getElementById("bg-loader").style.display = "block";
            document.getElementById("bg-loader").innerText = "SAVING...";
            await fetch(SCRIPT_URL, { method: "POST", body: JSON.stringify({ action: "update_profile", uid: currentUser, bio: bio, pic: pic }) });
            localStorage.removeItem("hx_pfp_temp");
            location.reload();
        }

        async function doFollow() {
            document.getElementById("bg-loader").style.display = "block";
            await fetch(SCRIPT_URL, { method: "POST", body: JSON.stringify({ action: "follow", uid: currentUser, target: viewTarget }) });
            location.reload();
        }

        function toggleAuth(v) { 
            document.getElementById("login-view").style.display = v === "login" ? "block" : "none";
            document.getElementById("signup-view").style.display = v === "signup" ? "block" : "none";
        }

        async function userAuth(m) {
            let p = { action: m };
            if (m === "login") { p.username = document.getElementById("logUser").value; p.password = document.getElementById("logPass").value; }
            else { p.username = document.getElementById("sigUser").value; p.email = document.getElementById("sigEmail").value; p.password = document.getElementById("sigPass").value; }
            if (!p.username || !p.password) return alert("Fill all fields");

            document.getElementById("bg-loader").style.display = "block";
            const r = await fetch(SCRIPT_URL, { method: "POST", body: JSON.stringify(p) });
            const res = await r.json();
            if (res.status === "Success") {
                localStorage.setItem("hx_comm_user", res.data.username);
                localStorage.setItem("hx_comm_role", res.data.role || "User");
                location.reload();
            } else alert(res.data);
            document.getElementById("bg-loader").style.display = "none";
        }

        function logout() { localStorage.clear(); location.href = "profile.html"; }

        loadProfile();
    </script>
</body>
</html>